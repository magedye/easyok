name: üõ°Ô∏è EasyData Fortress CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  # --------------------------------------------------------------------------
  # CI GOVERNANCE MODE (NON-NEGOTIABLE)
  # --------------------------------------------------------------------------
  ENV: ci
  APP_ENV: ci

  # Security MUST be enforced in CI environment
  AUTH_ENABLED: true
  RBAC_ENABLED: true
  RLS_ENABLED: true

  # Training & Governance Settings
  ENABLE_TRAINING_PILOT: false
  TRAINING_READINESS_ENFORCED: true
  ENABLE_AUDIT_LOGGING: true

  # Explicit Test Gates
  RUN_INTEGRATION_TESTS: true
  RUN_ORACLE_TESTS: false        # Oracle database is explicitly skipped in CI
  RUN_TELEMETRY_TESTS: false     # Telemetry is explicitly skipped in CI

  # Silence non-essential operational noise
  ENABLE_TELEMETRY: false
  ENABLE_OTEL: false

jobs:
  fortress-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ----------------------------------------------------------------------
      # 1. Initialization & Cleanup
      # ----------------------------------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üßπ Free Disk Space (CI Stability)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      # ----------------------------------------------------------------------
      # 2. Backend Environment (Python)
      # ----------------------------------------------------------------------
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üîç Backend Dependency Audit & Install
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip install -r requirements.txt
          pip-audit # Fails build if high-risk vulnerabilities are found

      # ----------------------------------------------------------------------
      # 3. Governance & Architectural Enforcement
      # ----------------------------------------------------------------------
      - name: üèõÔ∏è Architectural Governance Check
        run: |
          # Install the custom architectural linter
          pip install -e ./flake8_easydata_arch/
          # Enforce layer separation and coding standards
          flake8 app

      # ----------------------------------------------------------------------
      # 4. Backend Testing (Governed)
      # ----------------------------------------------------------------------
      - name: üß™ Backend Test Suite (Governed)
        run: |
          pytest -q -rs
        env:
          PYTHONWARNINGS: ignore

      # ----------------------------------------------------------------------
      # 5. Frontend Environment (Node.js)
      # ----------------------------------------------------------------------
      - name: üì¶ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üß™ Frontend Install, Audit & Test
        run: |
          cd frontend
          npm ci
          npm audit --audit-level=high
          npm test -- --watch=false

      # ----------------------------------------------------------------------
      # 6. API Contract Validation (Binding)
      # ----------------------------------------------------------------------
      - name: üìú Validate OpenAPI & Streaming Contracts
        run: |
          # Use Spectral to enforce OpenAPI standards and contract parity
          npx @stoplight/spectral-cli lint docs/api/*.yaml

      # ----------------------------------------------------------------------
      # 7. Startup Verification (Smoke Test)
      # ----------------------------------------------------------------------
      - name: üöÄ Backend Startup Smoke Test
        run: |
          # Start server in background
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          # Wait for boot
          sleep 5
          # Verify basic reachability
          curl -f http://localhost:8000/api/v1/health/llm || exit 1