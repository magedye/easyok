# ุชูุฑูุฑ: ุงุณุชูุชุงุฌ ูุชูุตูุงุช - SQLGuard (ุชุญูู ุงูุงูุชูุงู)

**ุงููุชูุฌุฉ ุงูุณุฑูุนุฉ:** โ CASE A โ ุฅูุฌุงุจู ุฒุงุฆู. SQLGuard ููุนู ุนูู ูุณุงุฑ `/api/v1/ask` ูุงูุชูุฑูุฑ ุงููุคุฑุดู ูุงู ููุถููููุงู (ุณุฌู `ask` ูุน `status=completed` ููู ุญูู `sql` ูุงุฑุบ ูNDJSON ุฃุธูุฑ ุฎุทุฃ โ ูุง ุชูููุฐ ูุนูู).

---

## ููุฎุต ุฅุนุงุฏุฉ ุงูุฅูุชุงุฌ ูุงูุฃุฏูุฉ ๐
- ุชู ุชุดุบูู ุงุฎุชุจุงุฑ ุงูุญูููุฉ (NDJSON) ูุญูููุง ูุฃุธูุฑ ุฃู ุนูุฏ ุฅุฌุจุงุฑ `SQLGuard.validate_and_normalise` ุนูู ุฑูู ุงุณุชุซูุงุก (`SQLGuardViolation`) ูุฅู ุงูุฎูููุฉ:
  - ุชูุตุฏุฑ chunk ูู ููุน `error` ูุงุญุฏ ููุทุ ุซู `end`ุ ููุง ุชูุตุฏุฑ `data` ุฃู `technical_view` ุฃู `business_view`.
  - ูุง ูุญุฏุซ ุชูููุฐ SQL ูุงูุนู (ุญูู `sql` ูู `audit_logs` ูุจูู ูุงุฑุบ).
- ุณุฌูุงุช ุงูู Audit ุชูุธูุฑ ุฃุญูุงููุง ุตููุง `ask` ูุน `status="completed"` ุจูููุง ูุง ูุญุชูู ุงูุญูู `sql` ุนูู ูุต โ ูุฐุง ุณููู ูุถูู ูููู ููุณ ุชูููุฐูุง ููู SQL.

---

## ุงูุฃุณุจุงุจ ุงูุฌุฐุฑูุฉ ุงููุญุชููุฉ ๐ง
- ุชุฑุชูุจ ุชุณุฌูู ุงูุฃุญุฏุงุซ: ุงูุชุทุจูู ูุณุฌู ุฃุญุฏุงุซ `ask` (ุจุฏุฃ / ููุชูู) ูุจู ุฅุชูุงู ูุญุต ุงูุณูุงูุฉ ูุงููุฑุงุฑ ุงูููุงุฆูุ ููุง ูููุชุฌ ุณุฌูุงุช "ููุชููุฉ" ุจูุง SQL ุนูุฏ ุงูุญุธุฑ.
- ูุญุต ููุงูุง ูุฏุฎูุฉ ุถุนูู (ูุซูุงู ุงุณุชุฎุฏุงู ุดุฑุงุฆุญ ูุตูุฉ ูุน ูุณุงูุงุช ูุญุณุจ) ูุฏ ูููููุช ููุงุฐุฌ ูุฌููุฉ ูู ุงูุงุณุชุนูุงูุงุช ุงูุถุงุฑุฉ.

---

## ุชูุตูุงุช ุนูููุฉ ุนูุฏ ุฌูุจ/ุงูุชุนุงูู ูุน ูุงุนุฏุฉ ุจูุงูุงุช ูุธุงู ุฌุฏูุฏุฉ ๐งญ
1. ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุขููุฉ (ุญุฏ ุฃุฏูู):
   - `ENV=ci|production`
   - `AUTH_ENABLED=true`
   - `RBAC_ENABLED=true`
   - `RLS_ENABLED=true`
   - `ENABLE_AUDIT_LOGGING=true`
   - `TRAINING_READINESS_ENFORCED=true`
   - `SYSTEM_DB_PATH=./data/<new-logs>.db`

2. ุฅูุดุงุก ุณูุงุณุฉ ูุตูู Schema ูุดุทุฉ *ูุจู* ุงูุชุดุบูู ุบูุฑ ุงููุญูู:
```bash
SYSTEM_DB_PATH=./data/new-logs.db python - << 'PY'
from app.services.schema_policy_service import SchemaPolicyService
SchemaPolicyService().commit_policy(db_connection_id=None, schema_name='PROD', allowed_tables=[], allowed_columns={}, excluded_tables=[], excluded_columns={}, created_by='setup_script')
PY
```

3. ุงุฎุชุจุงุฑุงุช ุงูุชุญูู (ุจุนุฏ ุงูุฅูุดุงุก):
   - ุดุบูู ุงุฎุชุจุงุฑุงุช ุงูุญูููุฉ ุฐุงุช ุงูุตูุฉ:
```bash
ENV=ci AUTH_ENABLED=true ENABLE_AUDIT_LOGGING=true RBAC_ENABLED=true RLS_ENABLED=true SYSTEM_DB_PATH=./data/new-logs.db pytest -q tests/test_sql_guard_violation_ndjson.py
```
   - ุชุญูู ูู NDJSON: ูุฌูุฏ `error` ูุงุญุฏ ุซู `end` ุนูุฏ ุงูุชูุงู SQLGuardุ ูุนุฏู ูุฌูุฏ `data`.
   - ุงูุญุต `audit_logs` ููุชุฃูุฏ ุฃู ุงูุญูู `sql` ุฅูุง ูุญูู SQL ุตุงูุญูุง ุนูุฏ ุงูุชูููุฐ ุฃู ูุงุฑุบูุง ุนูุฏ ุงูุญุธุฑ.

4. ูุญุต ุณุฌูุงุช ุงูุชุฑุญูู (ุฅู ููุฌูุฏ):
   - ุชุฃูุฏ ุฃู ุชุฑุญูู ุงูุณุฌูุงุช ูุง ูุฎูู `Blocked_SQL_Attempt` ูุฒููุฉ ุฃู ูุคุซุฑ ุนูู ุดุฑุท ุงูุชุฏุฑูุจ (ุงูุชุญูู ูู ุงูุฃุณุงุจูุน ุงูุณุจุนุฉ ุงูุฃุฎูุฑุฉ).

5. ุงุนุชุจุงุฑุงุช ุชุดุบูููุฉ ุณุฑูุนุฉ:
   - ุฅุฐุง ูุฌุฏุช ุณุทุฑูุง `ask` ูุน `status=completed` ู`sql==""` ูุงุนุชุจุฑูุง ุญุงูุฉ "ููุชููุฉ ููู ูู ุชูููุฐ" ุนูุฏ ุงูุชุญููู.
   - ูุชุญุณูู ุงูุงุชุณุงูุ ูููุตุญ ุจุชุนุฏูู ุชุณุฌูู ุงูุฃุญุฏุงุซ ูุงุญููุง ูุชูููุฒ ุญุงูุงุช "ุฃูููุช ุจุฏูู ุชูููุฐ" ุจูุถูุญ (ุงูุชุฑุงุญ ุชุดุบูููุ ุบูุฑ ุฅูุฒุงูู ุญุงููุงู).

---

## ุฎุทูุงุช ุชุงููุฉ ููุชุฑุญุฉ (ูููููู ุชูููุฐูุง ูู) โ
- ุฅูุดุงุก ููู DB ุฌุฏูุฏ ูุฅูุดุงุก ุณูุงุณุฉ Schema ูุดุทุฉ ุชููุงุฆููุง.
- ุชุดุบูู ุงุฎุชุจุงุฑุงุช smoke ูgovernance ุถุฏ ุงูู DB ุงูุฌุฏูุฏุฉ ูุฅุฑุณุงู ููุฎุต ุงููุชุงุฆุฌ.

---

*ููู ูููุดุฃ ุชููุงุฆููุง ุจูุงุณุทุฉ ูุญุต Go-Live: SQLGuard Bypass Reproduction & Triage.*
