# ๐งพ ูุซููุฉ ุนูุฏ ุงูู API ุงูุดุงูู (Master API Contract)

ูุฐู ุงููุซููุฉ ุชุตู ููููุฉ ุชูุงุตู ูุงุฌูุฉ ุงููุณุชุฎุฏู (ุงููุฑููุช ุฅูุฏ) ูุน ูุงุฌูุฉ ุงูุจุฑูุฌุฉ ุงูุฎูููุฉ (Backend) ูููุธุงูุ ูุน ุชูุถูุญ ููุงุฐุฌ ุงูุทูุจุงุช ูุงูุงุณุชุฌุงุจุงุช ูุงูุฃุฎุทุงุก ุงููุญุชููุฉ. ููุฏู ูุฐุง ุงูุนูุฏ ุฅูู ุถูุงู ุงูุงุณุชูุฑุงุฑ ุนูุฏ ุชุญุฏูุซ ูููููุงุช ุงููุธุงู ุฃู ุชุบููุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ูุญุฑู Vanna.

## 1. ุงููุตุงุฏูุฉ (Authentication)

ุฌููุน ุงูููุงุท ุงูููุงุฆูุฉ (Endpoints) ุงููุญููุฉ ุชุชุทูุจ ุฅุฑุณุงู ุฑูุฒ JWT ูู ุชุฑููุณุฉ `Authorization` ุจุงุณุชุฎุฏุงู ุงูุตูุบุฉ `Bearer <token>`. ููุจุบู ุฃู ูุญุชูู ุงูุฑูุฒ ุนูู ูุนุฑู ุงููุณุชุฎุฏู (`sub`) ูุฏูุฑู (`role`) ููุทุงูุงุช ุงููุตูู (`scopes`). ููุชูู ุตูุงุญูุฉ ุงูุฑูุฒ ุจุนุฏ ูุชุฑุฉ ูุชู ุชุญุฏูุฏูุง ูู ุงูุฅุนุฏุงุฏุงุช.

## 2. ุงูููุงุท ุงูููุงุฆูุฉ (Endpoints)

### 2.1 โโโPOST โโโ`/api/v1/ask`

- **ุงููุตู:** ุงุณุชูุจุงู ุณุคุงู ุจุงููุบุฉ ุงูุทุจูุนูุฉ ูุชูููุฐ ุนูููุฉ RAG ูุฅูุชุงุฌ SQL ูุชุดุบููู ุซู ุจุซ ุงููุชุงุฆุฌ ุนูู ูุฑุงุญู.
- **ุทูุจ (Request):**
  ```json
  {
    "question": "ูุง ูู ุฅุฌูุงูู ุงููุจูุนุงุช ูุฐุง ุงูุดูุฑุ",
    "context": { "schema": "SCOTT", "examples": [] }
  }
  ```
  - `question`โ (ูุต): ุงูุณุคุงู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุฃู ุงูุฅูุฌููุฒูุฉ (ุฅูุฒุงูู).
  - `context`โ (ูุงุฆู): ูุนูููุงุช ุฅุถุงููุฉ ูุซู ุงููุฎุทุท ุฃู ุฃูุซูุฉ ุงูุงุณุชุนูุงูุงุช (ุงุฎุชูุงุฑู).
- **ุงุณุชุฌุงุจุฉ (Response):** ุจุซ ุจุชูุณูู NDJSON ุนุจุฑ SSE (ServerโSent Events)ุ ูู ุณุทุฑ JSON ููุซู ูุฑุญูุฉ:
  - ุงููุฑุญูุฉ ุงูุฃููู (data):
    ```json
    { "phase": "data", "sql": "SELECT ...", "rows": [...], "total_rows": 50, "timestamp": "2025-12-26T09:00:00Z" }
    ```
  - ุงููุฑุญูุฉ ุงูุซุงููุฉ (chart):
    ```json
    { "phase": "chart", "type": "bar", "config": { "x": "category", "y": "amount" } }
    ```
  - ุงููุฑุญูุฉ ุงูุซุงูุซุฉ (summary):
    ```json
    { "phase": "summary", "text": "ุงููุณุชุฎุฏููู ุงูุฃูุซุฑ ุฅููุงููุง ูู ..." }
    ```
  - ูุฑุญูุฉ ุงูุฎุทุฃ (error) ุฅุฐุง ุญุฏุซ ุฎุทุฃ:
    ```json
    { "phase": "error", "message": "ุฑุณุงูุฉ ุงูุฎุทุฃ" }
    ```
- **ุฑููุฒ ุงูุฃุฎุทุงุก ุงููุญุชููุฉ:**
  - `invalid_query`: SQL ุบูุฑ ุตุงูุญ ุฃู ูุญุชูู ุนูููุงุช ููููุนุฉ.
  - `permission_denied`: ุงููุณุชุฎุฏู ูุง ููุชูู ุงูุตูุงุญูุงุช ุงููุงุฒูุฉ.
  - `service_unavailable`: ุฎุทุฃ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ูุฒูุฏ ุงููููุฐุฌ.
  - `unauthorized`: ุฑูุฒ JWT ููููุฏ ุฃู ุบูุฑ ุตุงูุญ.

### 2.2 โโโPOST โโโ`/api/v1/training`

- **ุงููุตู:** ุฅุถุงูุฉ ุนูุตุฑ ุชุฏุฑูุจ (ุณุคุงู + SQL) ููุชู ุงุณุชุฎุฏุงูู ูู ุงูุฐุงูุฑุฉ ุงููุนุฒุฒุฉ RAG. ูุชุทูุจ ุตูุงุญูุฉ `training:upload`.
- **ุทูุจ:**
  ```json
  {
    "question": "ูุง ูู ุฃุนูู ุฎูุณ ููุชุฌุงุช ูุจูุนุงุ",
    "sql": "SELECT * FROM products ORDER BY sales DESC FETCH FIRST 5 ROWS ONLY",
    "metadata": { "source": "admin" }
  }
  ```
- **ุงุณุชุฌุงุจุฉ:**
  ```json
  {
    "status": "ok",
    "message": "Training item received",
    "data": null,
    "error_code": null,
    "timestamp": "2025-12-26T09:00:00Z"
  }
  ```
- **ุฑููุฒ ุงูุฃุฎุทุงุก:**
  - `permission_denied`: ุงููุณุชุฎุฏู ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุฑูุน.
  - `invalid_query`: ูู ุญุงู ูุงู SQL ูุฑููุถูุง ูู ุฌุฏุงุฑ ุงูุญูุงูุฉ.

### 2.3 โโโGET โโโ`/api/v1/health`

- **ุงููุตู:** ุงูุชุญูู ูู ุฌุงูุฒูุฉ ุงูุฎุฏูุฉ.
- **ุทูุจ:** ุจุฏูู ุฌุณู.
- **ุงุณุชุฌุงุจุฉ:**
  ```json
  {
    "status": "ok",
    "timestamp": "2025-12-26T09:00:00Z"
  }
  ```

## 3. ููุงุฐุฌ ุงูุจูุงูุงุช (Request/Response Schemas)

ูุชู ุชุนุฑูู ููุงุฐุฌ ุงูุทูุจุงุช ุนุจุฑ Pydanticุ ูุฃูููุง:

- **QueryRequest**:
  - `question: str`
  - `context: Optional[dict]`
- **TrainingItem**:
  - `question: str`
  - `sql: str`
  - `metadata: Optional[dict]`
- **Response** (ููุญุฏ):
  - `status: str`
  - `message: Optional[str]`
  - `data: Any`
  - `error_code: Optional[str]`
  - `timestamp: datetime`

## 4. ุฑููุฒ ุงูุฎุทุฃ (Error Codes)

| ุงูุฑูุฒ | ุงูุญุงูุฉ | ุงูุฑุณุงูุฉ ุงูุงูุชุฑุงุถูุฉ | ููุงุญุธุงุช |
|------|-------|-------------------|-----------|
| `invalid_query` | 400 | SQL ุบูุฑ ุตุงูุญ | ุชู ุฑูุถ SQL ูู ุฌุฏุงุฑ ุงูุญูุงูุฉ ุฃู ูุดู ุงูุชุญูู |
| `unauthorized` | 401 | ูุตุงุฏูุฉ ูุทููุจุฉ | ูู ูุชู ุชูุฏูู ุฑูุฒ JWT ุฃู ุบูุฑ ุตุงูุญ |
| `permission_denied` | 403 | ููุณ ูุฏูู ุตูุงุญูุฉ | ุฏูุฑ ุงููุณุชุฎุฏู ูุง ูุณูุญ ุจุชูููุฐ ุงูุนูููุฉ |
| `service_unavailable` | 503 | ุงูุฎุฏูุฉ ุบูุฑ ูุชุงุญุฉ ูุคูุชูุง | ูุดู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃู ุงููููุฐุฌ |
| `internal_error` | 500 | ุฎุทุฃ ุบูุฑ ูุชููุน | ุฎุทุฃ ุบูุฑ ูุนุฑูู ูู ุงูุณูุฑูุฑ |

## 5. ููุงุญุธุงุช ุฅุถุงููุฉ

- ูุชู ุชูููุฐ ุฌููุน ุงูุงุณุชุนูุงูุงุช ุจุชูููุฏ READโONLYุ ููุง ููุณูุญ ุจุฃู ุนูููุงุช ุชุนุฏูู ููุจูุงูุงุช.
- ูุชู ุชุทุจูู ูููุฏ RLS (ุชุตููุฉ ุงูุตููู) ุจูุงุกู ุนูู ูุทุงูุงุช ุงููุณุชุฎุฏู ุงูููุฌูุฏุฉ ูู ุฑูุฒ JWT.
- ูุฏุนู ุงูุจุซ ุซูุงุซ ูุฑุงุญู ููุง ูู ููุถุญุ ูููู ูููุงุฌูุฉ ุงูุฃูุงููุฉ ุฅุธูุงุฑ ุงููุคุดุฑุงุช ุฃุซูุงุก ุงูุชุธุงุฑ ูู ูุฑุญูุฉ.