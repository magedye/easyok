openapi: 3.0.3

info:
  title: EasyData v16 Core Engine (The Constitution)
  version: "16.4.0-platinum"
  description: |
    The SUPREME AUTHORITATIVE INTERFACE for the EasyData AI Engine.
    
    ## ðŸ“œ Constitutional Rules (Hard Constraints)
    
    1. **RAG-First Mandate:** SQL generation MUST be preceded by context retrieval.
    2. **Read-Only Architecture:** ALL SQL MUST be SELECT queries only. Violations are fatal errors.
    3. **Streaming Protocol:** Chat MUST use SSE with defined event sequence:
       `auth` -> `thinking` -> `context` -> `technical_view` -> `data` -> `chart` -> `summary` -> `done`.
    4. **Dual-View Output:** Every successful response MUST generate both Business
       (Summary/Chart) AND Technical (SQL/Metadata) views.
    5. **Arabic RTL Support:** System MUST handle Arabic queries with proper RTL layout metadata.
    6. **Assumption Transparency:** ALL assumptions MUST be declared before execution.
    7. **Asset Persistence:** Queries are assets (`QueryAsset`). Users MUST be able to save/pin them.
    
    **Violation of any Hard Constraint constitutes a Critical System Failure.**

servers:
  - url: http://localhost:6666/api/v1
    description: Production API Gateway

tags:
  - name: Streaming
    description: Real-time RAG interactions (The Core)
  - name: Assets
    description: Persistent Query Management (The Memory)
  - name: System
    description: Health and Readiness

paths:

  /chat/stream:
    post:
      tags: [Streaming]
      summary: Start a RAG-First Streaming Session
      operationId: startChatStream
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatRequest"
      responses:
        "200":
          description: >
            SSE stream established.
            The stream MUST terminate with an EventDone event.
          content:
            text/event-stream:
              schema:
                type: string
        "400":
          description: Validation Error
        "401":
          description: Unauthorized
        "403":
          description: Firewall Violation

  /assets/queries:
    post:
      tags: [Assets]
      summary: Create Query Asset
      description: >
        Asset creation is ONLY allowed for successfully executed
        and firewall-approved queries.
      operationId: createQueryAsset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryAssetCreate"
      responses:
        "201":
          description: Asset Created

    get:
      tags: [Assets]
      summary: List Query Assets
      operationId: listQueryAssets
      responses:
        "200":
          description: List of assets

  /health:
    get:
      tags: [System]
      summary: Deep System Health Check
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

components:

  schemas:

    # ------------------------------------------------------------------
    # REQUEST
    # ------------------------------------------------------------------

    ChatRequest:
      type: object
      required: [message, datasource_id]
      properties:
        message:
          type: string
        datasource_id:
          type: string
          format: uuid
        conversation_id:
          type: string
          format: uuid
        language:
          type: object
          properties:
            code:
              type: string
              enum: [ar, en, auto]
            direction:
              type: string
              enum: [rtl, ltr]

    # ------------------------------------------------------------------
    # STREAM EVENTS
    # ------------------------------------------------------------------

    StreamEvent:
      oneOf:
        - $ref: "#/components/schemas/EventAuth"
        - $ref: "#/components/schemas/EventThinking"
        - $ref: "#/components/schemas/EventContext"
        - $ref: "#/components/schemas/EventTechnicalView"
        - $ref: "#/components/schemas/EventData"
        - $ref: "#/components/schemas/EventChart"
        - $ref: "#/components/schemas/EventSummary"
        - $ref: "#/components/schemas/EventError"
        - $ref: "#/components/schemas/EventDone"

    EventAuth:
      type: object
      properties:
        status: { enum: ["authenticated"] }

    EventThinking:
      type: object
      properties:
        stage:
          enum: [retrieval, generation, validation, execution]
        message:
          type: string

    EventContext:
      type: object
      required: [sources]
      properties:
        sources:
          type: array
          items:
            type: object
            properties:
              type: { enum: [sql_pair, ddl, doc] }
              relevance: { type: number }
              snippet: { type: string }

    # ------------------------------------------------------------------
    # ðŸ”§ UPDATED TECHNICAL VIEW (v16.4.0)
    # ------------------------------------------------------------------

    EventTechnicalView:
      type: object
      required: [sql, is_safe, assumptions, dialect, datasource_type]
      properties:
        sql:
          type: string
        is_safe:
          type: boolean
        dialect:
          type: string
          enum: [oracle, postgresql, mssql]
        datasource_type:
          type: string
          enum: [oracle, postgresql, mssql]
        assumptions:
          type: array
          items: { type: string }
        execution_time_ms:
          type: integer

    # ------------------------------------------------------------------
    # ðŸ”§ UPDATED DATA EVENT (v16.4.0)
    # ------------------------------------------------------------------

    EventData:
      type: object
      properties:
        rows:
          type: array
          items: { type: object }
        columns:
          type: array
          items: { type: string }
        row_count:
          type: integer
        chunk_index:
          type: integer
        is_last_chunk:
          type: boolean

    EventChart:
      type: object
      required: [type, config]
      properties:
        type:
          enum: [bar, line, pie, scatter, table, indicator]
        config:
          type: object

    EventSummary:
      type: object
      required: [text]
      properties:
        text:
          type: string
        language:
          enum: [ar, en]

    EventDone:
      type: object
      required: [status]
      properties:
        status:
          enum: ["completed"]

    EventError:
      type: object
      required: [code, message]
      properties:
        code:
          enum:
            - FIREWALL_BLOCK
            - DB_CONNECTION_FAILED
            - DB_TIMEOUT
            - RAG_CONTEXT_INSUFFICIENT
            - ASSUMPTION_VALIDATION_FAILED
            - ASSET_CREATION_DENIED
            - LLM_ERROR
        message:
          type: string
        suggestion:
          type: string

    # ------------------------------------------------------------------
    # ASSETS
    # ------------------------------------------------------------------

    QueryAsset:
      type: object
      required: [id, name, sql, owner_id]
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        sql: { type: string }
        question: { type: string }
        chart_config: { $ref: "#/components/schemas/EventChart" }
        owner_id: { type: string }
        created_at: { type: string, format: date-time }

    QueryAssetCreate:
      type: object
      required: [name, sql, question, chart_config]
      properties:
        name: { type: string }
        sql: { type: string }
        question: { type: string }
        chart_config: { $ref: "#/components/schemas/EventChart" }

    # ------------------------------------------------------------------
    # HEALTH
    # ------------------------------------------------------------------

    HealthResponse:
      type: object
      required: [status, components]
      properties:
        status:
          enum: [ok, degraded]
        components:
          type: object
          properties:
            database_pool: { type: boolean }
            vector_store: { type: boolean }
            llm_gateway: { type: boolean }
            rag_service:
              type: object
              properties:
                status: { type: string }
