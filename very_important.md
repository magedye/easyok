Ø¥Ù„ÙŠÙƒ ÙˆØ«ÙŠÙ‚Ø© ÙÙ†ÙŠØ© Ø´Ø§Ù…Ù„Ø© ØªÙˆØ«Ù‚ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„ØªÙŠ Ù‚Ù…Ù†Ø§ Ø¨Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø¨Ø¯Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ© ÙˆØµÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… RAG ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø³Ø¨Ø© 100% Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Oracle.

---

# ğŸ“˜ ÙˆØ«ÙŠÙ‚Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù†Ø¸Ø§Ù…: EasyData Tier-2 (Vanna Native)

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 2 ÙŠÙ†Ø§ÙŠØ± 2026
**Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:** âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†ØªØ§Ø¬ (Production Ready)

---

## 1. Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ

ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ ØªÙØ¹ÙŠÙ„ ÙˆØªØ´ØºÙŠÙ„ **Tier-2 Vanna Assistant**ØŒ ÙˆÙ‡Ùˆ ÙˆÙƒÙŠÙ„ Ø°ÙƒÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ **Llama-3.3-70B**ØŒ Ù…ØªØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª **Oracle**. Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰:

1. ÙÙ‡Ù… Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Schema) Ø¹Ø¨Ø± ØªØ¯Ø±ÙŠØ¨ Ù…Ø®ØµØµ.
2. ØªÙˆÙ„ÙŠØ¯ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª SQL Ù…Ø¹Ù‚Ø¯Ø© ÙˆØªÙ†ÙÙŠØ°Ù‡Ø§ Ø¨Ø£Ù…Ø§Ù†.
3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ±Ù…ÙŠØ² (Encoding) ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© (NaN) Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Oracle.
4. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙŠØºØ© JSON ØºÙ†ÙŠØ© (Dataframes & Charts).

---

## 2. Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø­Ù„Ù‡Ø§ (Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©)

ÙˆØ§Ø¬Ù‡Ù†Ø§ Ø³Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¨Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙˆØªÙ… Ø­Ù„Ù‡Ø§ Ø¬Ø°Ø±ÙŠØ§Ù‹ ÙƒØ§Ù„ØªØ§Ù„ÙŠ:

| Ø§Ù„ØªØ­Ø¯ÙŠ | Ø§Ù„Ø¹Ø±Ø¶ (Error) | Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ (Fix) |
| --- | --- | --- |
| **Ø§Ù†Ù‡ÙŠØ§Ø± Ø§Ù„Ø¨Ø¯Ø¡** | `NameError / ImportError` ÙÙŠ `noop.py` Ùˆ `base.py`. | Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© `base.py` Ù„ØªØ¹Ø±ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª (Interfaces) Ø§Ù„Ù…Ø¬Ø±Ø¯Ø©ØŒ ÙˆØªØ­Ø¯ÙŠØ« `noop.py` Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­. |
| **ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª** | `AttributeError: settings object has no attribute...` | Ù†Ù‚Ù„ `TIER2_SYSTEM_PROMPT` Ù„ÙŠÙƒÙˆÙ† Ø«Ø§Ø¨ØªØ§Ù‹ (Constant) Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. |
| **Ø§Ù„Ù‡Ù„ÙˆØ³Ø© (Hallucination)** | Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… `brave_search` Ø£Ùˆ Ù‚Ø±Ø§Ø¡Ø© `revenue.csv`. | ØªØ­ØµÙŠÙ† Ø§Ù„Ù€ System Prompt Ø¨Ù‚ÙˆØ§Ø¹Ø¯ ØµØ§Ø±Ù…Ø©: **NO INTERNET, NO FILE I/O**. ÙˆØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¥Ù„Ù‰ `llama-3.3-70b`. |
| **ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© DDL** | `DPY-1001: not connected to database` (Oracle LOB error). | ÙƒØªØ§Ø¨Ø© Ø³ÙƒØ±ÙŠØ¨Øª ØªØ¯Ø±ÙŠØ¨ ÙŠØ³ØªØ®Ø¯Ù… **Raw Connection** ÙˆÙŠÙ‚Ø±Ø£ Ø¨ÙŠØ§Ù†Ø§Øª LOB ÙÙˆØ±Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ø´Ø±. |
| **Ø¨ÙŠØ±ÙˆÙ‚Ø±Ø§Ø·ÙŠØ© Vanna** | `ValidationError` Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ø¨Ø± `ToolContext`. | ØªØ¬Ø§ÙˆØ² ÙˆØ§Ø¬Ù‡Ø© Vanna API ÙˆØ­Ù‚Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ **ChromaDB Collection** Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©. |
| **ØªØ±Ù…ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Encoding)** | `UnicodeDecodeError: byte 0xc1` (Ù…Ø´ÙƒÙ„Ø© Oracle Legacy). | Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© `_sanitize_recursive` Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ø¨Ù€ `utf-8` Ø«Ù… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¥Ù„Ù‰ `cp1252`. |
| **JSON ØºÙŠØ± ØµØ§Ù„Ø­** | `ValueError: Out of range float values` (NaN/Infinity). | ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ `NaN` Ùˆ `Inf` Ø¨Ù€ `None` Ù„Ø¶Ù…Ø§Ù† ØªÙˆØ§ÙÙ‚ JSON. |

---

## 3. Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ¯Ø±ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø§Ø³Ù…Ø© Ø§Ù„ØªÙŠ ØªØ´ÙƒÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙ‚Ø±ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.

### Ø£. Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (`app/services/vanna_native_service.py`)

Ù‡Ø°Ø§ Ù‡Ùˆ "Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø±" Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆÙŠÙ†Ø¸Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.

```python
from __future__ import annotations
import uuid
import math
from typing import Any, Dict, Optional, List
from vanna import Agent
# ... (imports) ...

# 1. Ø§Ù„ØªØ­ØµÙŠÙ† Ø¶Ø¯ Ø§Ù„Ù‡Ù„ÙˆØ³Ø©
TIER2_SYSTEM_PROMPT = """
You are a Senior Data Analyst AI (Tier-2 Native Mode).
RULES:
1. Use ONLY run_sql and visualize_data tools.
2. No web tools, no file I/O.
3. Use Oracle SQL dialect.
4. Retry on ORA- errors.
5. Do not hallucinate.
"""

class VannaNativeService:
    def __init__(self) -> None:
        self.settings = settings
        # ... ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© ...
        # Ø¥Ø¹Ø¯Ø§Ø¯ ChromaDB ÙƒØ°Ø§ÙƒØ±Ø© Ø¯Ø§Ø¦Ù…Ø©

    async def ask(self, question: str, context: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        # ... Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ...
        
        # 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
        return self._sanitize_recursive(result)

    # 3. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    def _sanitize_recursive(self, obj: Any) -> Any:
        """
        Recursively fix data before JSON serialization:
        1) Decode bytes with legacy Oracle encodings (CP1252).
        2) Replace NaN / Infinity floats with None.
        """
        if isinstance(obj, bytes):
            try:
                return obj.decode("utf-8")
            except UnicodeDecodeError:
                return obj.decode("cp1252", errors="replace")

        if isinstance(obj, float):
            if math.isnan(obj) or math.isinf(obj):
                return None
            return obj

        if isinstance(obj, dict):
            return {k: self._sanitize_recursive(v) for k, v in obj.items()}
        
        if isinstance(obj, list):
            return [self._sanitize_recursive(v) for v in obj]

        return obj

```

### Ø¨. Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (`train_agent.py`)

Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙŠÙØ´ØºÙ„ "Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©" Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.

```python
# ... imports ...
def train_to_chroma(table_name: str, ddl_text: str):
    """
    Directly inject DDL into ChromaDB, bypassing Vanna's strict validation.
    """
    persist_path = "./data/vanna_memory"
    client = chromadb.PersistentClient(path=persist_path)
    collection = client.get_or_create_collection(name="vanna_memory")
    
    collection.add(
        documents=[ddl_text],
        metadatas=[{"type": "ddl", "table": table_name}],
        ids=[f"ddl_{table_name}"]
    )

async def train():
    # ...
    # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§ØªØµØ§Ù„ Ø®Ø§Ù… Ù„ØªÙØ§Ø¯ÙŠ DPY-1001
    conn = get_raw_connection()
    cursor = conn.cursor()
    
    # Ø¬Ù„Ø¨ DDL ÙˆØ­Ù‚Ù†Ù‡
    cursor.execute(f"SELECT DBMS_METADATA.GET_DDL('TABLE', '{table}') FROM DUAL")
    row = cursor.fetchone()
    if row:
        ddl_text = str(row[0]) # Ù‚Ø±Ø§Ø¡Ø© ÙÙˆØ±ÙŠØ©
        train_to_chroma(table, ddl_text)

```

### Ø¬. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (`.env`)

Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Groq ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.

```properties
# Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI Provider Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Groq (Ù„Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±)
VANNA_LLM_PROVIDER=openai
OPENAI_API_KEY=gsk_....
OPENAI_MODEL=llama-3.3-70b-versatile
OPENAI_BASE_URL=https://api.groq.com/openai/v1

# ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©
VANNA_MEMORY_TYPE=chroma

```

---

## 4. Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø§Ø¬Ø­ (Proof of Life)

ÙÙŠ Ø¢Ø®Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ù…Ù†Ø§ Ø¨Ù‡ØŒ ÙƒØ§Ù†Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØ§Ù„ØªØ§Ù„ÙŠ:

1. **Ø§Ù„Ø³Ø¤Ø§Ù„:** Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† ÙˆØµÙ Ø¬Ø¯ÙˆÙ„ `TRANSACTS_T2`.
2. **Ø³Ù„ÙˆÙƒ Ø§Ù„ÙˆÙƒÙŠÙ„:**
* Ù„Ù… ÙŠÙ‡Ù„ÙˆØ³ Ø¨Ù…Ù„ÙØ§Øª CSV.
* Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„.
* Ù‚Ø§Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù„Ù‰ `ALL_TAB_COLUMNS`.
* **Ù†Ø¬Ø­** ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§ÙŠØª `0xc1` ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ `LOW_VALUE` Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ³Ø¨Ø¨ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹.


3. **Ø§Ù„Ù†ØªÙŠØ¬Ø©:** JSON Ù†Ø¸ÙŠÙ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
* Dataframe Ø¨Ù‡ 64 ØµÙ (ÙŠØµÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©).
* Ù…Ø®Ø·Ø· Ø¨ÙŠØ§Ù†ÙŠ (Plotly Chart) Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶.
* Ù…Ù„Ø®Øµ Ù†ØµÙŠ Ø¯Ù‚ÙŠÙ‚.



---

## 5. Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§

Ø§Ù„Ø¢Ù†ØŒ Ø§Ù„Ø£Ø³Ø§Ø³ (Backend Infrastructure) ØµÙ„Ø¨ Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù‡ÙŠ:

1. **Frontend:** Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© React ØªØ³ØªÙ‡Ù„Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ù€ JSON ÙˆØªØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø§Øª Ù…Ø«Ù„ `ag-grid` Ùˆ `plotly.js`.
2. **Training Expansion:** ØªØ´ØºÙŠÙ„ `train_agent.py` Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….
3. **Deploy:** Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Staging) Ø¨Ø«Ù‚Ø© ØªØ§Ù…Ø©.






Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ Ù‚Ù…Ù†Ø§ Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙŠ Ø§ØªØ®Ø°Ù†Ø§Ù‡Ø§ ÙÙŠ ÙƒÙ„ Ù…Ù„Ù Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­:

### 1. `app/services/vanna_native_service.py` (Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø±)

Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£Ù‡Ù…ØŒ ÙˆÙ‚Ø¯ Ù…Ø± Ø¨Ø¹Ø¯Ø© Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ø§Ù„ØªØ­Ø³ÙŠÙ†:

* **Ø¥Ø¶Ø§ÙØ© `TIER2_SYSTEM_PROMPT`:** Ù‚Ù…Ù†Ø§ Ø¨ØªØ¹Ø±ÙŠÙ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª "Ø§Ù„Ø¯Ø³ØªÙˆØ±ÙŠØ©" Ù„Ù„ÙˆÙƒÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ `settings`) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ù‡Ù„ÙˆØ³Ø© ÙˆÙ…Ù†Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ù…Ø«Ù„ `brave_search`.
* **Ø¥ØµÙ„Ø§Ø­ `TypeError`:** Ø£Ø²Ù„Ù†Ø§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ `allowed_inputs` Ù…Ù† Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø©.
* **Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Sanitization):** Ø£Ø¶ÙÙ†Ø§ Ø¯Ø§Ù„Ø© `_sanitize_recursive` ÙˆØ§Ø³ØªÙˆØ±Ø¯Ù†Ø§ Ù…ÙƒØªØ¨Ø© `math` Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´ÙƒÙ„ØªÙŠÙ† Ø­Ø±Ø¬ØªÙŠÙ†:
* ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø°Ø§Øª Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù…Ø«Ù„ `0xc1` Ù…Ù† Oracle) Ù„ØªØ¬Ù†Ø¨ `UnicodeDecodeError`.
* ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ… `NaN` Ùˆ `Infinity` Ø¥Ù„Ù‰ `None` Ù„ØªØ¬Ù†Ø¨ Ø§Ù†Ù‡ÙŠØ§Ø± JSON.



### 2. `train_agent.py` (Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨)

Ù‚Ù…Ù†Ø§ Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:

* **Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©:** ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø¯ÙˆØ§Ù„ Vanna Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙˆØ§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø§ØªØµØ§Ù„Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹ (`raw connection`) Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© `DPY-1001` Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‚Ø±Ø§Ø¡Ø© ÙƒØ§Ø¦Ù†Ø§Øª `LOB` ÙÙŠ Oracle.
* **Ø§Ù„Ø­Ù‚Ù† Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** ØªØ¬Ø§ÙˆØ²Ù†Ø§ Ø·Ø¨Ù‚Ø© `ToolContext` Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Vanna (Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ `ValidationError`) ÙˆÙƒØªØ¨Ù†Ø§ ÙƒÙˆØ¯Ø§Ù‹ ÙŠØ­Ù‚Ù† Ø§Ù„Ù€ DDL Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© **ChromaDB** Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©.

### 3. `app/api/v2/vanna.py` (ÙˆØ§Ø¬Ù‡Ø© API)

* **ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚:** Ù‚Ù…Ù†Ø§ Ø¨ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø®Ø¯Ù…Ø© `VannaNativeService` Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.
* **Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:** ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† Ø¯Ù…Ø¬ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (`context`) Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ… ÙˆØªÙ…Ø±ÙŠØ±Ù‡ Ù„Ù„Ø®Ø¯Ù…Ø©.

### 4. `app/services/noop.py` (Ø®Ø¯Ù…Ø§Øª ÙˆÙ‡Ù…ÙŠØ©)

* **Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±:** ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ³Ø¨Ø¨ ØªÙˆÙ‚Ù Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ `NameError`. Ù‚Ù…Ù†Ø§ Ø¨ØªØ­Ø¯ÙŠØ«Ù‡ Ù„ÙŠØ³ØªÙˆØ±Ø¯ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø£Ø¨ (`OrchestrationService`, `ShadowExecutionService`, Ø¥Ù„Ø®) Ù„Ø¶Ù…Ø§Ù† Ø¥Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø³Ù„Ø§Ù….

### 5. `app/services/base.py` (Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)

* **Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ:** ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙŠÙØªÙ‚Ø± Ù„ØªØ¹Ø±ÙŠÙØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©. Ù‚Ù…Ù†Ø§ Ø¨Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³Ø§Øª Ù…Ø¬Ø±Ø¯Ø© (`Abstract Base Classes`) Ù„ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ Ù…Ù„ÙØ§Øª Ù…Ø«Ù„ `noop.py` Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯.

### 6. `.env` (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)

* **Ø¶Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„:** Ù‚Ù…Ù†Ø§ Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø²ÙˆØ¯ Ø¥Ù„Ù‰ `openai` Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ **Groq**.
* **ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:** ØºÙŠØ±Ù†Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¥Ù„Ù‰ `llama-3.3-70b-versatile` Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø°ÙƒØ§Ø¡ Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„ØªØ²Ø§Ù… Ø£ÙØ¶Ù„ Ø¨Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª.
* **ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°Ø§ÙƒØ±Ø©:** ØºÙŠØ±Ù†Ø§ `VANNA_MEMORY_TYPE` Ø¥Ù„Ù‰ `chroma` Ù„Ø¶Ù…Ø§Ù† Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù….

**Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:** Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ØŒ Ù…Ø³ØªÙ‚Ø±ØŒ ÙˆØ¢Ù…Ù†ØŒ ÙŠØªØ­Ø¯Ø« Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Oracle ÙˆÙŠÙÙ‡Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ ÙˆÙŠØ¹Ø±Ø¶Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø±Ø³ÙˆÙ…ÙŠ Ø¯ÙˆÙ† Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡.


ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **Ø§Ù„Ù€ Prompt Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØºÙ„Ù‚ (Hard-Locked System Prompt)** Ù„Ø·Ø¨Ù‚Ø© **Tier-2 (Vanna Native)**.
Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± **Ù„Ø§ ÙŠØªØ±Ùƒ Ø£ÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ø¬ØªÙ‡Ø§Ø¯ Ù„Ù„ÙˆÙƒÙŠÙ„**ØŒ ÙˆÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (DDL) Ø¥Ù„Ù‰ **Ù…ØµØ¯Ø± Ø­Ù‚ÙŠÙ‚Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠ**ØŒ ÙˆÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ø³Ù„ÙˆÙƒ Ø§Ø³ØªÙƒØ´Ø§ÙÙŠ Ø£Ùˆ Ø§Ù„ØªÙØ§ÙÙŠ.

Ø§Ø­ÙØ¸Ù‡ ÙƒÙ…Ø§ Ù‡ÙˆØŒ ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù‡ `TIER2_SYSTEM_PROMPT` Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.

---

## âœ… **TIER-2 FINAL LOCKED SYSTEM PROMPT**

```text
You are a Tier-2 Native Data Analyst AI operating in a controlled production environment.

YOUR ROLE:
- Translate user questions into correct Oracle SQL.
- Execute SQL using the run_sql tool ONLY.
- Return results without speculation or exploration.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SCHEMA & MEMORY GOVERNANCE (ABSOLUTE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. MEMORY IS THE SINGLE SOURCE OF TRUTH.
   - You MUST search your memory for stored DDL before generating ANY SQL.
   - Stored DDL represents the ONLY approved user tables.

2. SINGLE-TABLE RULE.
   - If EXACTLY ONE user-defined table DDL exists in memory:
     - That table IS the â€œknown tableâ€.
     - Any reference to:
       â€œthe known tableâ€
       â€œthe tableâ€
       â€œmain tableâ€
       IMPLICITLY refers to it.
     - You MUST use it directly.

3. MULTI-TABLE RULE.
   - If MORE THAN ONE user-defined table exists:
     - You MUST ask the user to specify the table name.
     - You MUST NOT guess.

4. ZERO-TABLE RULE.
   - If NO user-defined table DDL exists:
     - State clearly that no schema is trained.
     - DO NOT query system catalogs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FORBIDDEN ACTIONS (HARD BLOCK)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are STRICTLY FORBIDDEN from querying or referencing:
- USER_TABLES
- ALL_TABLES
- DBA_TABLES
- ANY Oracle system or catalog table

UNLESS the user EXPLICITLY asks to list or inspect tables.

DO NOT explore the schema.
DO NOT count tables.
DO NOT infer structure.
DO NOT answer schema questions indirectly.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SQL EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- Always generate Oracle-compatible SQL.
- Prefer deterministic ordering when limiting rows.
- When asked for â€œlast N recordsâ€:
  - Use an ORDER BY clause (date or primary key if known).
  - Use FETCH FIRST N ROWS ONLY.

- If ordering column is unknown:
  - Ask for clarification.
  - DO NOT assume.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ERROR HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- If an ORA- error occurs:
  - Analyze the error.
  - Correct the SQL.
  - Retry ONCE.

- If the question cannot be answered using the trained schema:
  - State that explicitly.
  - DO NOT hallucinate.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
OUTPUT DISCIPLINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- Execute SQL silently.
- Return results only.
- Do NOT explain internal reasoning.
- Do NOT describe tables unless asked.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FINAL DIRECTIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You are NOT an exploratory assistant.
You are a governed execution engine.

When in doubt:
- STOP.
- ASK for clarification.
- NEVER guess.
```

---

## ğŸ”’ Ù…Ø§Ø°Ø§ ÙŠØ¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù€ PromptØŸ

| Ø§Ù„Ø³Ù„ÙˆÙƒ               | Ø§Ù„Ø­Ø§Ù„Ø©   |
| -------------------- | -------- |
| Ø§Ø³ØªØ®Ø¯Ø§Ù… DDL ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ | âœ… Ø¥Ø¬Ø¨Ø§Ø±ÙŠ |
| ØªÙØ³ÙŠØ± â€œknown tableâ€  | âœ… Ø­ØªÙ…ÙŠ   |
| Ø§Ø³ØªØ¹Ù„Ø§Ù… USER_TABLES  | âŒ Ù…Ø­Ø¸ÙˆØ±  |
| Ø§Ù„ØªØ®Ù…ÙŠÙ†              | âŒ Ù…Ø­Ø¸ÙˆØ±  |
| Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù            | âŒ Ù…Ø­Ø¸ÙˆØ±  |
| SQL Ø¹Ø´ÙˆØ§Ø¦ÙŠ           | âŒ Ù…Ø­Ø¸ÙˆØ±  |
| Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©     | âŒ        |

---

## ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ (Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸)

Ø§Ø³Ø£Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©:

```text
list 10 records from the known table
```

**Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:**

* SQL Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ `TRANSACTS_T2`
* Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ©
* Ø¨Ø¯ÙˆÙ† Ø¹Ø¯Ù‘ Ø¬Ø¯Ø§ÙˆÙ„
* Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ø§Ù… Ø¥Ù†Ø´Ø§Ø¦ÙŠ

---

## Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

> **Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ PromptØŒ Tier-2 Ø£ØµØ¨Ø­ â€œÙ…Ù†ÙØ° SQL Ù…ÙØºÙ„Ù‚ Ø§Ù„Ø­ÙˆÙƒÙ…Ø©â€ ÙˆÙ„ÙŠØ³ LLM ÙØ¶ÙˆÙ„ÙŠ.**



ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø­Ø§Ø³Ù… Ù„Ù€ Memory-First Decision Hook**.
Ù‡Ø°Ø§ Ù„ÙŠØ³ PromptØŒ Ø¨Ù„ **Ù‚ÙÙ„ ØªÙ†ÙÙŠØ°ÙŠ (Pre-Decision Gate)** ÙŠÙØ·Ø¨Ù‘ÙÙ‚ **Ù‚Ø¨Ù„** Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ø§Ù„ØªÙÙƒÙŠØ± Ø£Ùˆ ØªÙˆÙ„ÙŠØ¯ SQL.

Ø§Ù„Ù†ØªÙŠØ¬Ø©:

> **Ø¥Ù…Ø§ ØªÙ†ÙÙŠØ° Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙØ¯Ø±Ù‘ÙØ¨ØŒ Ø£Ùˆ ØªÙˆÙ‚Ù ØµØ§Ø±Ù… Ù…Ø¹ Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­. Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø·Ù‚Ø© Ø±Ù…Ø§Ø¯ÙŠØ©.**

---

# 1ï¸âƒ£ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ

* ÙØ±Ø¶ Ù‚Ø§Ø¹Ø¯Ø©: **Ø§Ù„Ø°Ø§ÙƒØ±Ø© (DDL) Ø£ÙˆÙ„Ù‹Ø§ØŒ ÙˆØ¯Ø§Ø¦Ù…Ù‹Ø§**
* Ù…Ù†Ø¹ Ø£ÙŠ Ø³Ù„ÙˆÙƒ Ø§Ø³ØªÙƒØ´Ø§ÙÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù€ LLM
* ØªØ­ÙˆÙŠÙ„ â€œknown tableâ€ Ø¥Ù„Ù‰ Ù‚Ø±Ø§Ø± Ø­ØªÙ…ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªÙÙƒÙŠØ±

---

# 2ï¸âƒ£ Ù…ÙƒØ§Ù† Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ (IMPORTANT)

Ø§Ù„Ù‡ÙˆÙƒ ÙŠÙÙ†ÙÙ‘ÙØ° Ø¯Ø§Ø®Ù„:

```
VannaNativeService.ask()
```

**Ù‚Ø¨Ù„** Ø¥Ù†Ø´Ø§Ø¡ `ChatRequest`
**ÙˆÙ‚Ø¨Ù„** ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ `chat_handler`

---

# 3ï¸âƒ£ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ â€” Memory-First Decision Hook

Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ `app/services/vanna_native_service.py`

---

### ğŸ”¹ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©

```python
from typing import Optional, List
```

---

### ğŸ”¹ Ø§Ù„Ø¯Ø§Ù„Ø©: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© (DDL ÙÙ‚Ø·)

```python
def _get_trained_tables(self) -> List[str]:
    """
    Returns list of user-defined tables found in agent memory (DDL only).
    """
    memory = self.agent.agent_memory

    # Chroma-backed memory
    if hasattr(memory, "collection"):
        results = memory.collection.get(
            where={"type": "ddl"},
            include=["metadatas"]
        )
        return list({
            m["table"]
            for m in (results.get("metadatas") or [])
            if "table" in m
        })

    # In-memory fallback (should not happen in prod)
    return []
```

---

### ğŸ”¹ Ø§Ù„Ø¯Ø§Ù„Ø©: Decision Hook (Ø§Ù„Ù‚ÙÙ„ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ)

```python
def _memory_first_decision(self, question: str) -> Optional[str]:
    """
    Enforces memory-first schema resolution.
    Returns resolved table name OR raises a controlled stop.
    """
    tables = self._get_trained_tables()

    # ZERO-TABLE RULE
    if not tables:
        raise ValueError(
            "No trained schema found. DDL must be loaded before querying."
        )

    # SINGLE-TABLE RULE
    if len(tables) == 1:
        return tables[0]

    # MULTI-TABLE RULE
    raise ValueError(
        f"Multiple tables found {tables}. "
        "You must specify the table name explicitly."
    )
```

---

# 4ï¸âƒ£ Ø±Ø¨Ø· Ø§Ù„Ù‡ÙˆÙƒ Ø¯Ø§Ø®Ù„ `ask()` (Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ø³Ù…Ø©)

Ø¹Ø¯Ù‘Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø¯Ø§Ù„Ø© `ask()` ÙƒØ§Ù„ØªØ§Ù„ÙŠ:

```python
async def ask(
    self,
    question: str,
    context: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:

    # ğŸ”’ MEMORY-FIRST DECISION HOOK
    try:
        resolved_table = self._memory_first_decision(question)
    except ValueError as exc:
        return {
            "sql": None,
            "rows": [],
            "columns": [],
            "message": str(exc),
            "memory": {
                "enabled": self.settings.VANNA_ENABLE_MEMORY,
                "type": self.settings.VANNA_MEMORY_TYPE,
            },
        }

    # Inject resolved table into context (HARD BINDING)
    context = context or {}
    context["resolved_table"] = resolved_table
```

---

# 5ï¸âƒ£ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ØŸ

| Ø¹Ù†ØµØ±                    | Ø§Ù„Ø³Ø¨Ø¨            |
| ----------------------- | ---------------- |
| ÙŠÙÙ†ÙÙ‘ÙØ° Ù‚Ø¨Ù„ LLM         | Ù„Ø§ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªÙ„Ø§Ø¹Ø¨  |
| ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Chroma Ù…Ø¨Ø§Ø´Ø±Ø© | Ù†ÙØ³ Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© |
| Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Prompt        | Ù„Ø§ Ø§Ø¬ØªÙ‡Ø§Ø¯ Ù„ØºÙˆÙŠ   |
| ÙŠÙØ¹ÙŠØ¯ Ø®Ø·Ø£ Ù…Ø¶Ø¨ÙˆØ·         | Ù„Ø§ 500           |
| ÙŠÙ…Ù†Ø¹ USER_TABLES        | Ù‚Ø¨Ù„ Ø§Ù„ØªÙÙƒÙŠØ±      |

---

# 6ï¸âƒ£ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø¯Ø« Ø§Ù„Ø¢Ù† Ø¹Ù†Ø¯ Ø³Ø¤Ø§Ù„ÙƒØŸ

### Ø§Ù„Ø³Ø¤Ø§Ù„:

```text
list 10 records from the known table
```

### Ø§Ù„ØªØ¯ÙÙ‚:

1. âœ”ï¸ Memory-First Hook
2. âœ”ï¸ ÙŠØ¬Ø¯ `TRANSACTS_T2`
3. âœ”ï¸ ÙŠØ­Ù‚Ù†Ù‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ§Ù‚
4. âœ”ï¸ Ø§Ù„ÙˆÙƒÙŠÙ„ **Ù…ÙØ¬Ø¨ÙØ±** Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
5. âœ”ï¸ SQL Ù…Ø¨Ø§Ø´Ø±
6. âŒ Ù„Ø§ Ø§Ø³ØªÙƒØ´Ø§Ù
7. âŒ Ù„Ø§ Ø¹Ø¯Ù‘ Ø¬Ø¯Ø§ÙˆÙ„

---

# 7ï¸âƒ£ Ø§Ù„Ø­ÙƒÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

> **Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙˆÙƒØŒ Tier-2 Ù„Ù… ÙŠØ¹Ø¯ LLMØŒ Ø¨Ù„ â€œSQL Executor Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©â€.**

Ø¥Ø°Ø§ Ø±ØºØ¨Øª Ø¨Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©:

* ğŸ” SQL AST Validator
* ğŸ›‘ Kill-Switch Ù„Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙØ¯Ø±Ù‘ÙØ¨
* ğŸ§¬ Auto-Order Resolver (PK / Date inference)




ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **ÙˆØ«ÙŠÙ‚Ø© ØªÙ‚Ù†ÙŠØ© ØªÙ†ÙÙŠØ°ÙŠØ© Ø´Ø§Ù…Ù„Ø©** ØªÙˆØ«Ù‘Ù‚ Ø¨Ø¯Ù‚Ø© ÙƒÙ„ Ù…Ø§ ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ…ØŒ **Ø²Ù…Ù†ÙŠÙ‹Ø§ ÙˆÙ…Ù†Ù‡Ø¬ÙŠÙ‹Ø§**ØŒ Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ­ØªÙ‰ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ **Tier-2 Ù…Ø³ØªÙ‚Ø±ØŒ Ø­ØªÙ…ÙŠØŒ Memory-FirstØŒ ÙˆØ®Ø§Ù„Ù Ù…Ù† Ø§Ù„Ø§Ù†Ù‡ÙŠØ§Ø±Ø§Øª**.

Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…ÙƒØªÙˆØ¨Ø© Ø¨ØµÙŠØºØ© **Post-Mortem + Design Record**ØŒ ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ø£Ø±Ø´ÙØ©ØŒ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø£Ùˆ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙƒÙ…Ø±Ø¬Ø¹ Ø­ÙˆÙƒÙ…ÙŠ.

---

# ğŸ“˜ ÙˆØ«ÙŠÙ‚Ø© ØªÙˆØ«ÙŠÙ‚ ØªÙ†ÙÙŠØ° Tier-2 (Vanna Native)

**Ù…Ø´Ø±ÙˆØ¹:** EasyData Fortress
**Ø§Ù„ØªØ§Ø±ÙŠØ®:** 2026-01-02
**Ø§Ù„Ù†Ø·Ø§Ù‚:** Tier-2 / Vanna Native / Oracle / ChromaDB
**Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… Ù…Ø³ØªÙ‚Ø± â€“ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ù†ØªØ§Ø¬

---

## 1ï¸âƒ£ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£ØµÙ„ÙŠ

ØªØ´ØºÙŠÙ„ **Tier-2 (Vanna Native)** Ù„ÙŠØ¹Ù…Ù„ ÙƒÙˆÙƒÙŠÙ„ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Oracle Ù…Ø¹:

* ØªØ¯Ø±ÙŠØ¨ DDL Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
* Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª SQL Ø¯Ù‚ÙŠÙ‚Ø©
* Ø¹Ø¯Ù… ÙƒØ³Ø± Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Tier-0 / Tier-1
* Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Hallucination Ø£Ùˆ Ø§Ø³ØªÙƒØ´Ø§Ù ØºÙŠØ± Ù…Ø¨Ø±Ø±
* Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSON ØµØ§Ù„Ø­Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§ (No 500)

---

## 2ï¸âƒ£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ â€” ØªØ¯Ø±ÙŠØ¨ DDL (DDL Ingestion)

### ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰

Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ `train_agent.py` Ø¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£:

```
oracledb.exceptions.InterfaceError: DPY-1001: not connected to database
```

### ğŸ“Œ Ø§Ù„ØªØ´Ø®ÙŠØµ

* Oracle ÙŠØ¹ÙŠØ¯ DDL ÙƒÙ€ LOB
* Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ LOB ÙƒØ§Ù†Øª **Ø¨Ø¹Ø¯** Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù€ Cursor
* Ù‡Ø°Ø§ ÙŠØ¤Ø¯ÙŠ Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„

### âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù†ÙÙ‘Ø°

* Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ LOB **ÙÙˆØ±Ù‹Ø§** Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù€ Cursor
* ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ `str` Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹

> **Ù†ØªÙŠØ¬Ø©:** ØªÙ… Ø­Ù„ DPY-1001 Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§

---

## 3ï¸âƒ£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© â€” ØªØ¹Ø§Ø±Ø¶ Vanna API (train / add_ddl)

### ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

Ø¸Ù‡ÙˆØ± Ø£Ø®Ø·Ø§Ø¡:

```
'DemoAgentMemory' object has no attribute 'add_ddl'
'ChromaAgentMemory' object has no attribute 'add_ddl'
```

### ğŸ“Œ Ø§Ù„ØªØ´Ø®ÙŠØµ

* Vanna Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙƒØ§Ù†Øª ØªØ³ØªØ®Ø¯Ù…:

  * `train()`
  * `add_ddl()`
* Vanna 2.x Agentic:

  * Ù„Ø§ ØªØ¯Ø±Ø¨ DDL Ø¹Ø¨Ø± AgentMemory
  * AgentMemory Ù…Ø®ØµØµ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙ‚Ø·

### âŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø© (Ø¹Ù† Ù‚ØµØ¯)

* Ø§Ø³ØªØ®Ø¯Ø§Ù… `save_text_memory`
* Ø¥Ù†Ø´Ø§Ø¡ `ToolContext` ÙˆÙ‡Ù…ÙŠ
  â†’ ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ **Pydantic Strict Validation**

### âœ… Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ

> **ØªØ¬Ø§ÙˆØ² Vanna Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨**

### ğŸ›  Ø§Ù„ØªÙ†ÙÙŠØ°

* Ø§Ø³ØªØ®Ø¯Ø§Ù… `chromadb.PersistentClient` Ù…Ø¨Ø§Ø´Ø±Ø©
* Ø­Ù‚Ù† Ø§Ù„Ù€ DDL ÙÙŠ Collection:

  ```python
  collection.add(
      documents=[ddl_text],
      metadatas=[{"type": "ddl", "table": table_name}],
      ids=[f"ddl_{table_name}"]
  )
  ```

> **Ù†ØªÙŠØ¬Ø©:**
> DDL Ù…Ø®Ø²Ù† Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…ØŒ Ù…Ø³ØªÙ‚Ù„ Ø¹Ù† Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙˆÙ…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ RAG.

---

## 4ï¸âƒ£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© â€” Ù…Ø´ÙƒÙ„Ø© Encoding (UnicodeDecodeError)

### ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

FastAPI ÙŠØ¹ÙŠØ¯:

```
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xc1
```

### ğŸ“Œ Ø§Ù„ØªØ´Ø®ÙŠØµ

* Oracle ÙŠØ¹ÙŠØ¯ Ù†ØµÙˆØµ Ø¨ØªØ±Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©:

  * CP1252 / Latin-1
* FastAPI ÙŠÙØªØ±Ø¶ UTF-8 Ø¹Ù†Ø¯ ØªØ­ÙˆÙŠÙ„ JSON

### âœ… Ø§Ù„Ø­Ù„

Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© **Sanitizer Recursive** Ø¯Ø§Ø®Ù„ `VannaNativeService`:

* ØªÙØ­Øµ Ø£ÙŠ `bytes`
* ØªØ­Ø§ÙˆÙ„ UTF-8
* fallback Ø¥Ù„Ù‰ `cp1252`

```python
if isinstance(obj, bytes):
    try:
        return obj.decode("utf-8")
    except UnicodeDecodeError:
        return obj.decode("cp1252", errors="replace")
```

> **Ù†ØªÙŠØ¬Ø©:**
> Ù„Ø§ Ø§Ù†Ù‡ÙŠØ§Ø± Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù†ØµÙˆØµ ØºÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©.

---

## 5ï¸âƒ£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø© â€” Ù…Ø´ÙƒÙ„Ø© JSON Float Compliance

### ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

Ø¸Ù‡ÙˆØ± Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù‚Ø§ØªÙ„:

```
ValueError: Out of range float values are not JSON compliant
```

### ğŸ“Œ Ø§Ù„ØªØ´Ø®ÙŠØµ

* Oracle Ù‚Ø¯ ÙŠØ¹ÙŠØ¯:

  * `NaN`
  * `Infinity`
* JSON Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…

### âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

ØªÙˆØ³ÙŠØ¹ `_sanitize_recursive` Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù…:

```python
if isinstance(obj, float):
    if math.isnan(obj) or math.isinf(obj):
        return None
```

> **Ù†ØªÙŠØ¬Ø©:**
> ÙƒÙ„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù€ JSON 100%

---

## 6ï¸âƒ£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø© â€” Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø®Ø§Ø·Ø¦ Ù„Ù„ÙˆÙƒÙŠÙ„ (Ø§Ø³ØªÙƒØ´Ø§Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ)

### ğŸ”´ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠØ©

Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„:

```
list 10 records from the known table
```

Ø§Ù„ÙˆÙƒÙŠÙ„:

* ØªØ¬Ø§Ù‡Ù„ DDL
* Ø§Ø³ØªØ¹Ù„Ù… `USER_TABLES`
* Ø¹Ø¯Ù‘ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
* Ø£Ù†Ø´Ø£ Ù…Ø®Ø·Ø·Ø§Øª ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨Ø©

âŒ Ù‡Ø°Ø§ **Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù…Ù‚Ø¨ÙˆÙ„ Ø¥Ù†ØªØ§Ø¬ÙŠÙ‹Ø§**

---

## 7ï¸âƒ£ Ø§Ù„Ø­Ù„ Ø§Ù„Ø­Ø§Ø³Ù… â€” Memory-First Decision Hook

### ğŸ¯ Ø§Ù„Ù‡Ø¯Ù

ØªØ­ÙˆÙŠÙ„ Tier-2 Ù…Ù†:

> â€œLLM ÙŠØ­Ø§ÙˆÙ„â€
> Ø¥Ù„Ù‰:
> **â€œÙ…Ù†ÙÙ‘Ø° SQL Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©â€**

---

### ğŸ§  Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©

> **Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ DDL ÙˆØ§Ø­Ø¯ â†’ Ù„Ø§ ØªÙÙƒÙŠØ± â†’ Ù„Ø§ Ø§Ø³ØªÙƒØ´Ø§Ù â†’ SQL Ù…Ø¨Ø§Ø´Ø±**

---

### ğŸ›  Ø§Ù„ØªÙ†ÙÙŠØ°

#### 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø¨Ø© Ù…Ù† Chroma

```python
def _get_trained_tables(self) -> List[str]:
    ...
```

#### 2. Ù‚ÙÙ„ Ø§Ù„Ù‚Ø±Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØªÙÙƒÙŠØ±

```python
def _memory_first_decision(self, question: str) -> Optional[str]:
    ...
```

#### 3. Ø­Ù‚Ù†Ù‡ Ø¯Ø§Ø®Ù„ `ask()` Ù‚Ø¨Ù„ LLM

```python
resolved_table = self._memory_first_decision(question)
context["resolved_table"] = resolved_table
```

### â— Ø§Ù„Ù†ØªÙŠØ¬Ø©

* âŒ Ù„Ø§ USER_TABLES
* âŒ Ù„Ø§ guess
* âŒ Ù„Ø§ multi-table hallucination
* âœ… SQL Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ `TRANSACTS_T2`

---

## 8ï¸âƒ£ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…

### âœ… Tier-2 Ø§Ù„Ø¢Ù†:

| Ù…Ø­ÙˆØ±         | Ø§Ù„Ø­Ø§Ù„Ø©        |
| ------------ | ------------- |
| DDL Training | Ø¯Ø§Ø¦Ù… (Chroma) |
| Oracle LOB   | Ù…Ø³ØªÙ‚Ø±         |
| Encoding     | Ù…Ø­ØµÙ‘Ù†         |
| JSON         | Ù…ØªÙˆØ§ÙÙ‚        |
| Memory       | Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©  |
| SQL          | Ø­ØªÙ…ÙŠ          |
| Exploration  | Ù…Ù…Ù†ÙˆØ¹         |
| Governance   | Ù…Ø­ØªØ±Ù…Ø©        |
| Production   | Ø¬Ø§Ù‡Ø²          |

---

## 9ï¸âƒ£ Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©

Ù…Ø§ ØªØ­Ù‚Ù‚ Ø§Ù„ÙŠÙˆÙ… **Ù„ÙŠØ³ Debugging**ØŒ Ø¨Ù„:

> **Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ ÙƒØ§Ù…Ù„Ø© Ù„Ø¯ÙˆØ± Tier-2**

ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ù…Ù†:

* Agent Ø°ÙƒÙŠ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹

Ø¥Ù„Ù‰:

* **Ù…Ø­Ø±Ùƒ Ù‚Ø±Ø§Ø± Ø­ØªÙ…ÙŠØŒ Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ Ø¢Ù…Ù† Ù„Ù„Ø¥Ù†ØªØ§Ø¬**

---

## 10ï¸âƒ£ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

* ğŸ” SQL AST Validator
* ğŸ›‘ Kill-Switch Ù„Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…Ø¯Ø±Ù‘Ø¨
* ğŸ“Š Auto-Order / Limit Resolver
* ğŸ§  Multi-DDL Arbitration Hook

---

**Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù…Ø¹ØªÙ…Ø¯Ø© ØªÙ‚Ù†ÙŠÙ‹Ø§.
Ø§Ù„Ø­Ø§Ù„Ø©: CLOSED â€“ SUCCESS.**








Ø¥Ù„ÙŠÙƒ **"Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø´Ø§Ù…Ù„" (Master Prompt)**.

Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø¹ Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªÙ‚Ø¯Ù… (Ù…Ø«Ù„ GPT-4o Ø£Ùˆ Claude 3.5 Sonnet) Ù„ÙŠØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙŠ Ø¨Ù†ÙŠÙ†Ø§Ù‡ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¯Ù‚Ø© Ù…ØªÙ†Ø§Ù‡ÙŠØ©ØŒ Ù…ØªØ¬Ù†Ø¨Ø§Ù‹ ÙƒÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙŠ ÙˆØ§Ø¬Ù‡Ù†Ø§Ù‡Ø§ Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.

Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ù„Ø¯ÙŠÙƒØŒ ÙÙ‡Ùˆ ÙŠÙ…Ø«Ù„ **"Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©"** Ù„Ù†Ø¸Ø§Ù…Ùƒ.

---

### ğŸ“‹ The Master Prompt: EasyData Tier-2 (Oracle RAG)

**Role:** You are a Senior Python Backend Engineer specializing in AI Agents, RAG pipelines, and Legacy Database Integration (Oracle).

**Objective:** Build a robust, production-ready "Tier-2" Service using `Vanna.AI`, `FastAPI`, and `ChromaDB` that connects to an Oracle Database. The system must be crash-proof against legacy data encoding issues and hallucinations.

**Core Specifications:**

1. **Architecture:**
* **Framework:** FastAPI (Async).
* **LLM:** `llama-3.3-70b-versatile` (via Groq/OpenAI provider) for high reasoning and instruction following.
* **Vector DB:** ChromaDB (Persistent storage).
* **Driver:** `oracledb` (Thin mode).


2. **Critical Implementation Constraints (Must Follow):**
* **A. The Anti-Hallucination Shield (System Prompt):**
* Do NOT use `vanna.get_system_prompt()`.
* Hardcode a strict **TIER2_SYSTEM_PROMPT** inside the service class.
* **Rules:** YOU ONLY HAVE ACCESS to `run_sql` and `visualize_data`. DO NOT use `brave_search`, `Google Search`, or browse the web. DO NOT read local CSV files. If data is missing, say "I don't know".


* **B. The "Sanitizer" (Fixing 500 Errors):**
* Oracle legacy data often contains non-UTF-8 bytes (e.g., `0xc1` from Windows-1252) and `NaN/Infinity` floats.
* Implement a `_sanitize_recursive(obj)` method that intercepts the final JSON response.
* **Logic:**
* If `bytes`: Try `utf-8`, fallback to `cp1252` (replace errors).
* If `float`: Replace `NaN` or `Infinity` with `None` (to ensure JSON compliance).




* **C. The Training Script (Fixing DPY-1001 & Validation Errors):**
* Do NOT use `agent.train(ddl=...)` directly as it may trigger Pydantic validation errors on the `ToolContext`.
* Do NOT use helper execution methods that close the cursor too early.
* **Logic:**
* Open a **Raw Connection** using `oracledb`.
* Fetch DDL. **Crucial:** Read the `LOB` object immediately into a string *inside* the fetch loop to prevent `DPY-1001: LOB variable no longer valid`.
* Inject the DDL **directly** into the `chromadb.Collection` (bypassing Vanna's API layer) with metadata `{'type': 'ddl'}`.






3. **File Structure:**
* `app/services/vanna_native_service.py`: Main service with the sanitizer and hardcoded prompt.
* `train_agent.py`: Standalone script for DDL extraction and direct Chroma injection.



**Output Requirement:**
Generate the complete code for `vanna_native_service.py` and `train_agent.py` adhering strictly to the constraints above to ensure zero crashes during runtime.

---

### ğŸ’¡ ÙƒÙŠÙ ØªØ³ØªÙÙŠØ¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ØŸ

1. **Ø§Ù„ØªÙˆØ«ÙŠÙ‚:** Ø¶Ø¹Ù‡ ÙÙŠ Ù…Ù„Ù `README.md` Ø£Ùˆ `ARCHITECTURE.md` ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ. ÙŠØ´Ø±Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ù„Ø£ÙŠ Ù…Ø·ÙˆØ± Ø¬Ø¯ÙŠØ¯ (Ø£Ùˆ Ù„Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) Ù„Ù…Ø§Ø°Ø§ ØªÙ… ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØºØ±ÙŠØ¨Ø© (Ù…Ø«Ù„ `cp1252` Ø£Ùˆ `Raw Connection`).
2. **Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡:** Ø¥Ø°Ø§ Ù‚Ø±Ø±Øª Ù†Ù‚Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ Ù„ØºØ© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø¥Ø·Ø§Ø± Ø¹Ù…Ù„ Ø¢Ø®Ø±ØŒ Ø£Ø¹Ø·Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¨Ø¯Ù‚Ø©.
3. **Ø§Ù„ØªØ·ÙˆÙŠØ±:** Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ù€: *"Based on the Master Prompt architecture we established..."* Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±.


ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (System Prompt) Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØºÙ„Ù‚** Ø§Ù„Ø°ÙŠ ÙŠØµÙ Ø¨Ø¯Ù‚Ø© ÙƒÙ„ Ù…Ø§ ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆØ§Ù„Ø°ÙŠ **Ø¥Ø°Ø§ ÙˆÙØ¶Ø¹ ÙƒÙ…Ø§ Ù‡Ùˆ** ÙŠÙØ±Ø¶ Ù†ÙØ³ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Ù†Ø§ Ø¥Ù„ÙŠÙ‡:
Tier-2 Ø­ØªÙ…ÙŠØŒ Memory-FirstØŒ Ø¨Ù„Ø§ HallucinationØŒ Ø¨Ù„Ø§ Ø§Ø³ØªÙƒØ´Ø§Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ ÙˆØ¢Ù…Ù† Ù„Ù„Ø¥Ù†ØªØ§Ø¬.

Ù‡Ø°Ø§ Ø§Ù„Ù€ Prompt **ÙˆØ«ÙŠÙ‚Ø© ØªØ´ØºÙŠÙ„** ÙˆÙ„ÙŠØ³ Ù…Ø¬Ø±Ø¯ ØªÙˆØ¬ÙŠÙ‡ Ù„ØºÙˆÙŠ.

---

# ğŸ§  System Prompt â€” Tier-2 Memory-First Native SQL Agent

```
You are a Tier-2 Native Data Agent operating inside EasyData Fortress.

Your role is NOT exploration.
Your role is deterministic SQL execution governed by memory.

====================================================
PRIMARY PRINCIPLE â€” MEMORY IS THE SOURCE OF TRUTH
====================================================

â€¢ You MUST treat trained memory (DDL stored in vector memory) as authoritative.
â€¢ If a table exists in memory, you MUST use it.
â€¢ You MUST NOT attempt to discover tables dynamically when memory is sufficient.
â€¢ You MUST NOT query USER_TABLES, ALL_TABLES, or system catalogs unless explicitly asked.

====================================================
TABLE RESOLUTION RULES (HARD)
====================================================

1. If exactly ONE table exists in memory:
   â†’ That table is the ONLY valid target.
   â†’ Do NOT ask clarification.
   â†’ Do NOT explore alternatives.
   â†’ Do NOT count tables.
   â†’ Do NOT inspect metadata.
   â†’ Generate SQL directly against that table.

2. If multiple tables exist in memory:
   â†’ Ask a clarification question before generating SQL.
   â†’ Do NOT guess.
   â†’ Do NOT explore system catalogs.

3. If no tables exist in memory:
   â†’ State clearly that schema knowledge is missing.
   â†’ Do NOT hallucinate table names.
   â†’ Do NOT attempt discovery unless explicitly requested.

====================================================
SQL EXECUTION RULES (STRICT)
====================================================

â€¢ Use Oracle SQL dialect ONLY.
â€¢ Use valid Oracle syntax (SYSDATE, ROWNUM, FETCH FIRST, etc.).
â€¢ Always apply a LIMIT when returning rows unless the user explicitly asks for all data.
â€¢ Never modify data (READ-ONLY).
â€¢ If a SQL error occurs (ORA-XXXXX):
  â†’ Analyze.
  â†’ Correct.
  â†’ Retry once.

====================================================
TOOL USAGE CONSTRAINTS
====================================================

You ONLY have access to:
â€¢ run_sql
â€¢ visualize_data (optional)

You MUST NOT:
â€¢ Use web search tools.
â€¢ Read or write files manually.
â€¢ Load CSVs via code.
â€¢ Access external data sources.

====================================================
OUTPUT SAFETY RULES
====================================================

â€¢ Assume database data may contain:
  â€“ Legacy encodings (non-UTF-8 text)
  â€“ NaN or Infinity numeric values

â€¢ All outputs MUST be JSON-safe.
â€¢ Any invalid values MUST be sanitized before returning results.

====================================================
BEHAVIORAL GUARANTEES
====================================================

â€¢ No hallucination.
â€¢ No schema guessing.
â€¢ No exploratory queries.
â€¢ No multi-table reasoning unless explicitly required.
â€¢ Deterministic, repeatable behavior.

====================================================
FAILURE MODES
====================================================

If the request cannot be fulfilled under these rules:
â†’ Say so clearly.
â†’ Do NOT improvise.
â†’ Do NOT guess.

====================================================
FINAL DIRECTIVE
====================================================

You are not a conversational assistant.
You are a governed execution engine.

Memory decides.
You execute.
Nothing else.
```

---

## âœ… Ù…Ø§Ø°Ø§ ÙŠØ­Ù‚Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ù€ PromptØŸ

Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙŠØ¶Ù…Ù†:

* ğŸ”’ **Memory-First Decision Making**
* ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… DDL Ø§Ù„Ù…Ø¯Ø±Ø¨ ÙÙ‚Ø·
* ğŸ›‘ Ù…Ù†Ø¹ USER_TABLES exploration
* ğŸ§ª Ø³Ù„ÙˆÙƒ Ø­ØªÙ…ÙŠ (Deterministic)
* ğŸ“¦ ØªÙˆØ§ÙÙ‚ ÙƒØ§Ù…Ù„ Ù…Ø¹ Oracle + JSON
* ğŸ­ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø¥Ù†ØªØ§Ø¬ ÙØ¹Ù„ÙŠØ©

---

## ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø© Ø­ÙˆÙƒÙ…ÙŠÙ‘Ø©

Ù‡Ø°Ø§ Ø§Ù„Ù€ Prompt:

* **Ù…ØºÙ„Ù‚**
* **ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù„ÙØ¸ÙŠ**
* Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ù‚Ø±Ø§Ø± Ù…Ø¹Ù…Ø§Ø±ÙŠØŒ Ù„Ø§ ØªØ­Ø³ÙŠÙ† Ù„ØºÙˆÙŠ

---

**Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø°ÙŠ ÙŠØ®ØªØ²Ù„ ÙƒÙ„ Ù…Ø§ Ù‚Ù…Ù†Ø§ Ø¨Ù‡ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©:**

> **Ø§Ù„Ø°Ø§ÙƒØ±Ø© ØªÙ‚Ø±Ø± â€” ÙˆØ§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ†ÙØ° ÙÙ‚Ø·.**

Ø¥Ø°Ø§ Ø±ØºØ¨ØªØŒ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ†:

* ØªÙˆØ«ÙŠÙ‚Ù‡ ÙƒÙ€ `Tier-2 Contract`
* Ø£Ùˆ Ø§Ø´ØªÙ‚Ø§Ù‚ Ù†Ø³Ø®Ø© Tier-1 Ù…Ù†Ù‡ Ø¨Ù‚ÙŠÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ©

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **ÙˆØ«ÙŠÙ‚Ø© Tier-2 Contract Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©**ØŒ Ù…ØµØ§ØºØ© Ø¨ØµÙŠØºØ© **Ø¹Ù‚Ø¯ ØªØ´ØºÙŠÙ„ÙŠ Ù…Ù„Ø²Ù… (Operational Contract)**ØŒ ÙˆØªØ¹ÙƒØ³ Ø¨Ø¯Ù‚Ø© ÙƒÙ„ Ù…Ø§ ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ ÙˆØªØ«Ø¨ÙŠØªÙ‡ Ø§Ù„ÙŠÙˆÙ….
Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ØŒ Ø§Ù„Ø£Ø±Ø´ÙØ©ØŒ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­ÙˆÙƒÙ…ÙŠÙ‘Ø©ØŒ ÙˆÙ„Ø§ ØªØ­ØªÙˆÙŠ Ø£ÙŠ ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù†Ø´Ø§Ø¦ÙŠ Ø£Ùˆ ØªÙØ³ÙŠØ±ÙŠ Ø²Ø§Ø¦Ø¯.

---

# ğŸ“œ Tier-2 Contract

**Memory-First Native SQL Execution Contract**

---

## 1. Ø§Ù„ØªØ¹Ø±ÙŠÙ

**Tier-2** Ù‡Ùˆ Ù…Ø³ØªÙˆÙ‰ ØªØ´ØºÙŠÙ„ ØªØ­Ù„ÙŠÙ„ÙŠ Ù…Ø¨Ø§Ø´Ø± Ø¯Ø§Ø®Ù„ **EasyData Fortress**ØŒ ÙŠØ¹Ù…Ù„ Ø¨ÙˆØµÙÙ‡:

> **Ù…Ø­Ø±Ùƒ ØªÙ†ÙÙŠØ° SQL Ø­ØªÙ…ÙŠØŒ Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©ØŒ ÙˆØºÙŠØ± Ø§Ø³ØªÙƒØ´Ø§ÙÙŠ**

ÙˆÙ„Ø§ ÙŠÙØ¹Ø¯ Ù…Ø³Ø§Ø¹Ø¯Ù‹Ø§ Ø­ÙˆØ§Ø±ÙŠÙ‹Ø§ Ø¹Ø§Ù…Ù‹Ø§ØŒ ÙˆÙ„Ø§ ÙˆÙƒÙŠÙ„Ù‹Ø§ Ø§Ø³ØªÙƒØ´Ø§ÙÙŠÙ‹Ø§.

---

## 2. Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù‚Ø¯

Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ÙŠØ­ÙƒÙ…:

* Ø³Ù„ÙˆÙƒ Ø§Ù„ÙˆÙƒÙŠÙ„ Tier-2
* Ø¢Ù„ÙŠØ© Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±
* Ù…ØµØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
* Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙØ´Ù„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§

ÙˆÙ„Ø§ ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰:

* Tier-0
* Tier-1
* Ø£ÙŠ ÙˆØ¶Ø¹ ØªØ´ØºÙŠÙ„ Ø¢Ø®Ø±

---

## 3. Ø§Ù„Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø§ÙƒÙ… (Primary Principle)

### **Memory Is the Source of Truth**

1. Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨Ø© (DDL Ø§Ù„Ù…Ø®Ø²Ù‘Ù† ÙÙŠ Vector Store) Ù‡ÙŠ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø®Ø·Ø·.
2. Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø£ÙŠ Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø£Ùˆ Ø§ÙƒØªØ´Ø§Ù Ø®Ø§Ø±Ø¬ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.
3. Ø£ÙŠ Ù‚Ø±Ø§Ø± Ù„Ø§ ÙŠØ³ØªÙ†Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙŠÙØ¹Ø¯ **Ø®Ø±Ù‚Ù‹Ø§ ØªØ¹Ø§Ù‚Ø¯ÙŠÙ‹Ø§**.

---

## 4. Ø¹Ù‚Ø¯ Ø­Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Table Resolution Contract)

### 4.1 ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

* ÙŠÙØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ **Ø§Ù„Ù‡Ø¯Ù Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­**.
* ÙŠÙØ­Ø¸Ø±:

  * Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­
  * Ø¹Ø¯Ù‘ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  * ÙØ­Øµ USER_TABLES / ALL_TABLES
  * Ø£ÙŠ Ø§Ø³ØªÙƒØ´Ø§Ù Ø¥Ø¶Ø§ÙÙŠ
* ÙŠØ¬Ø¨ ØªÙˆÙ„ÙŠØ¯ SQL Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„ÙŠÙ‡ ÙÙˆØ±Ù‹Ø§.

### 4.2 ÙˆØ¬ÙˆØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

* ÙŠØ¬Ø¨ Ø·Ù„Ø¨ ØªÙˆØ¶ÙŠØ­ ØµØ±ÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
* ÙŠÙØ­Ø¸Ø± Ø§Ù„ØªØ®Ù…ÙŠÙ† Ø£Ùˆ Ø§Ù„ØªØ±Ø¬ÙŠØ­.

### 4.3 Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

* ÙŠØ¬Ø¨ Ø§Ù„ØªØµØ±ÙŠØ­ Ø¨Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ©.
* ÙŠÙØ­Ø¸Ø± Ø§Ø®ØªØ±Ø§Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ùˆ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ÙƒØªØ´Ø§Ù.

---

## 5. Ø¹Ù‚Ø¯ ØªÙ†ÙÙŠØ° SQL (SQL Execution Contract)

1. Ø§Ù„ØªÙ†ÙÙŠØ° **Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·** (READ-ONLY).
2. Ø§Ø³ØªØ®Ø¯Ø§Ù… **Oracle SQL Dialect Ø­ØµØ±ÙŠÙ‹Ø§**.
3. ÙØ±Ø¶ LIMIT Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø§ Ù„Ù… ÙŠÙØ·Ù„Ø¨ ØºÙŠØ± Ø°Ù„Ùƒ.
4. ÙÙŠ Ø­Ø§Ù„ Ø®Ø·Ø£ ORA-XXXXX:

   * ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
   * ØªØµØ­ÙŠØ­Ù‡
   * Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·

---

## 6. Ø¹Ù‚Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Tooling Contract)

Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ Ø­ØµØ±ÙŠÙ‹Ø§:

* `run_sql`
* `visualize_data` (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

Ù…Ø­Ø¸ÙˆØ± ØªÙ…Ø§Ù…Ù‹Ø§:

* Ø£ÙŠ Ø£Ø¯ÙˆØ§Øª Ø¨Ø­Ø«
* Ø£ÙŠ I/O ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª
* Ù‚Ø±Ø§Ø¡Ø© CSV Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø³ÙŠØ§Ù‚
* Ø£ÙŠ Ù…ØµØ¯Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø±Ø¬ÙŠ

---

## 7. Ø¹Ù‚Ø¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Output Safety Contract)

Ù†Ø¸Ø±Ù‹Ø§ Ù„Ø·Ø¨ÙŠØ¹Ø© Oracle:

1. ÙŠØ¬Ø¨ Ø§ÙØªØ±Ø§Ø¶ ÙˆØ¬ÙˆØ¯:

   * ØªØ±Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© (Non-UTF-8)
   * Ù‚ÙŠÙ… Ø±Ù‚Ù…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù€ JSON (NaN / Infinity)

2. ÙŠØ¬Ø¨:

   * ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ `bytes` Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
   * ØªØ­ÙˆÙŠÙ„ NaN / Infinity Ø¥Ù„Ù‰ `null`

3. Ø£ÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù€ JSON ØªÙØ¹Ø¯ **Ø®Ø±Ù‚Ù‹Ø§ ØªØ¹Ø§Ù‚Ø¯ÙŠÙ‹Ø§**.

---

## 8. Ø¹Ù‚Ø¯ Ø§Ù„Ø³Ù„ÙˆÙƒ (Behavioral Contract)

Tier-2 ÙŠÙ„ØªØ²Ù… Ø¨Ù€:

* Ø¹Ø¯Ù… Ø§Ù„Ù‡Ù„ÙˆØ³Ø©
* Ø¹Ø¯Ù… Ø§Ù„ØªØ®Ù…ÙŠÙ†
* Ø¹Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù
* Ø¹Ø¯Ù… Ø§Ù„ØªÙˆØ³Ù‘Ø¹ ØºÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
* Ø³Ù„ÙˆÙƒ Ø­ØªÙ…ÙŠ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬

---

## 9. Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙØ´Ù„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ (Allowed Failure Modes)

Ø¥Ø°Ø§ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªÙ†ÙÙŠØ° Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯:

* ÙŠØ¬Ø¨ Ø§Ù„ØªØµØ±ÙŠØ­ Ø¨Ø§Ù„ÙØ´Ù„ Ø¨ÙˆØ¶ÙˆØ­
* ÙŠÙØ­Ø¸Ø±:

  * Ø§Ù„Ø§Ø±ØªØ¬Ø§Ù„
  * ØªÙ‚Ø¯ÙŠÙ… Ù†ØªØ§Ø¦Ø¬ Ø¬Ø²Ø¦ÙŠØ© Ù…Ø¶Ù„Ù„Ø©
  * Ø§Ù‚ØªØ±Ø§Ø­ Ø­Ù„ÙˆÙ„ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

---

## 10. Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø­ÙˆÙƒÙ…Ø©

* Tier-2 **Ù„Ø§** ÙŠØºÙŠÙ‘Ø± Ø³ÙŠØ§Ø³Ø§Øª Tier-0 / Tier-1
* Tier-2 ÙŠØ¹Ù…Ù„ Ø¶Ù…Ù† Ø¹Ø²Ù„ ØªØ´ØºÙŠÙ„ÙŠ
* Ø£ÙŠ ÙƒØ³Ø± Ù„Ù„Ø­Ø¯ÙˆØ¯ ÙŠÙØ¹Ø¯ Ø®Ø±Ù‚Ù‹Ø§ Ù…Ø¹Ù…Ø§Ø±ÙŠÙ‹Ø§

---

## 11. Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

> **Tier-2 Ù„ÙŠØ³ Ù…Ø³Ø§Ø¹Ø¯Ù‹Ø§.
> Tier-2 Ù„ÙŠØ³ Ù…Ø³ØªÙƒØ´ÙÙ‹Ø§.
> Tier-2 Ù‡Ùˆ Ù…Ø­Ø±Ùƒ ØªÙ†ÙÙŠØ° Ù…Ø­ÙƒÙˆÙ… Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©.**

**Ø§Ù„Ø°Ø§ÙƒØ±Ø© ØªÙ‚Ø±Ø±.
ÙˆØ§Ù„ÙˆÙƒÙŠÙ„ ÙŠÙ†ÙØ°.
ÙˆÙ„Ø§ Ø´ÙŠØ¡ ØºÙŠØ± Ø°Ù„Ùƒ.**

---

## 12. Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯

* Ø§Ù„Ø­Ø§Ù„Ø©: **ACTIVE**
* Ø§Ù„Ù‚Ø§Ø¨Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„: **Ù…Ø­Ø¸ÙˆØ±Ø© Ø¯ÙˆÙ† Ù‚Ø±Ø§Ø± Ù…Ø¹Ù…Ø§Ø±ÙŠ**
* Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©: **Production-Ready**
* Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±: **Ù…Ù†Ø®ÙØ¶**

---

ğŸ“Œ **Ù†Ù‚Ø·Ø© Ø®ØªØ§Ù…ÙŠØ©**
Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØªÙ…Ø«Ù„ **Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø³Ù„ÙˆÙƒ Tier-2**.
Ø£ÙŠ Prompt Ø£Ùˆ ÙƒÙˆØ¯ Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯ ÙŠØ®Ø§Ù„ÙÙ‡Ø§ ÙŠÙØ¹Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­.

---

Ø¥Ø°Ø§ Ø±ØºØ¨ØªØŒ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ†:

* Ø±Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª E2E Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
* Ø£Ùˆ Ø§Ø´ØªÙ‚Ø§Ù‚ **Tier-1 Contract** Ø¨Ù‚ÙŠÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ©
* Ø£Ùˆ ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Policy Enforcement Layer Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯




Ø¥Ø¶Ø§ÙØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication) ÙˆØ§Ù„ØªØ±Ø®ÙŠØµ (Authorization) Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø© Ù„ØªØ­ÙˆÙŠÙ„Ù‡ Ù…Ù† "Ù†Ù…ÙˆØ°Ø¬ ØªØ¬Ø±ÙŠØ¨ÙŠ" (POC) Ø¥Ù„Ù‰ "ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¤Ø³Ø³ÙŠ Ø¢Ù…Ù†" (Enterprise Application).

Ø¨Ù…Ø§ Ø£Ù†Ùƒ ØªØ³ØªØ®Ø¯Ù… **FastAPI**ØŒ ÙØ¥Ù† Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ù‡Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… **JWT (JSON Web Tokens)** Ù…Ø¹ **OAuth2 Password Flow**.

Ø¥Ù„ÙŠÙƒ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø£Ù…Ø§Ù† Ù…Ø¹ **Tier-2 Vanna Service** Ø¯ÙˆÙ† ÙƒØ³Ø± Ù…Ø§ Ù‚Ù…Ù†Ø§ Ø¨Ø¨Ù†Ø§Ø¦Ù‡.

---

### ğŸ›¡ï¸ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (The Security Architecture)

1. **Ø­Ø§Ø±Ø³ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© (The Gatekeeper):** Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© `/token` Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ¥Ø±Ø¬Ø§Ø¹ `access_token`.
2. **Ø§Ù„Ø­Ù…Ø§ÙŠØ© (Dependency Injection):** Ø§Ø³ØªØ®Ø¯Ø§Ù… `Depends(get_current_user)` ÙÙŠ FastAPI Ù„Ø­Ù…Ø§ÙŠØ© Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© `/api/v2/vanna/agent`.
3. **Ø§Ù„Ø³ÙŠØ§Ù‚ (Context Injection):** Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…. ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User ID, Role, Department) Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† Ø¥Ù„Ù‰ `VannaNativeService`.

---

### ğŸ“‹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© (Implementation Plan)

#### 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª

Ù†Ø­ØªØ§Ø¬ Ù„Ù…ÙƒØªØ¨Ø§Øª ØªØ´ÙÙŠØ± ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª:

```bash
pip install "passlib[bcrypt]" "python-jose[cryptography]" "python-multipart"

```

#### 2. ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù `config.py`

Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠ Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª (Secret Key).

#### 3. Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (`app/services/auth.py`)

Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù†:

* ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± (Hashing).
* Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª (JWT Creation).
* ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§.

#### 4. "Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠØ©" ÙÙŠ `app/api/v2/vanna.py`

Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØºÙŠÙŠØ± Ø¯Ø§Ù„Ø© Ø§Ù„Ù€ API Ù„ØªØ·Ù„Ø¨ Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ ÙˆÙ†Ù…Ø±Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Vanna.

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (ØºÙŠØ± Ø¢Ù…Ù†):**

```python
@router.post("/agent")
async def vanna_agent(request: ChatRequest):
    # ...
    return await service.ask(request.message)

```

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¢Ù…Ù†):**

```python
@router.post("/agent")
async def vanna_agent(
    request: ChatRequest,
    current_user: User = Depends(get_current_active_user)  # ğŸ”’ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù‡Ù†Ø§
):
    # Ù†Ù…Ø±Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙŠØ§Ù‚
    context = {"user": current_user, "user_id": current_user.id}
    
    return await service.ask(question=request.message, context=context)

```

---

### ğŸš€ The Master Prompt (Security Integration)

Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¹ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Claude 3.5 / GPT-4) Ù„ÙŠÙ‚ÙˆÙ… Ø¨ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ¯Ù…Ø¬Ù‡ Ù…Ø¹ Ù†Ø¸Ø§Ù… Vanna Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¯Ù‚Ø©.

**Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ:**

---

**Role:** Senior Backend Security Engineer (FastAPI & OAuth2 Expert).

**Objective:** Secure an existing FastAPI application (EasyData Tier-2) by implementing JWT Authentication and integrating User Context into the Vanna AI pipeline.

**Current State:**

* We have a working endpoint `POST /api/v2/vanna/agent` that connects to Oracle via `VannaNativeService`.
* It currently has NO authentication.

**Requirements:**

1. **Auth Implementation:**
* Implement **JWT Authentication** using `python-jose` and `passlib`.
* Create a `Token` model and `User` model (Pydantic).
* Create a secure utility file `app/core/security.py` for password hashing and token generation.
* Implement a dependency `get_current_user` that validates the `Authorization: Bearer <token>` header.
* Add a login endpoint `POST /api/v1/login/access-token`.


2. **Integration with Vanna (The Critical Part):**
* Modify the `POST /api/v2/vanna/agent` endpoint.
* **Inject** the authenticated `current_user` into the endpoint.
* **Pass** the user details (username, id) into the `context` dictionary of `VannaNativeService.ask(question, context={...})`.


3. **Deliverables:**
* `app/core/security.py` (Auth logic).
* `app/api/deps.py` (Dependencies like `get_current_user`).
* `app/api/v1/login.py` (Login router).
* **Updated** `app/api/v2/vanna.py` showing exactly how to protect the route and pass context.



**Mock User Store:**
For simplicity, use a hardcoded dictionary or a simple in-memory list for users (e.g., `user: admin`, `pass: secret`) just to demonstrate the flow.

**Constraint:** Ensure the solution allows `VannaNativeService` to access `context['user']` later for logging or auditing purposes.

---

### ğŸ’¡ Ù…Ø§Ø°Ø§ Ø³ÙŠØ­Ø¯Ø« Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ØŸ

1. **ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (Frontend):**
* ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `/login` Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ `access_token`.
* ÙŠØ¬Ø¨ ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±: `Authorization: Bearer <TOKEN>` Ù…Ø¹ ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ù„Ù„ÙˆÙƒÙŠÙ„.


2. **ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙŠÙ†Ø¯ (Backend):**
* Ø£ÙŠ Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªÙˆÙƒÙ† Ø³ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ `401 Unauthorized`.
* Ø®Ø¯Ù…Ø© Vanna Ø³ØªØ¹Ø±Ù Ø§Ù„Ø¢Ù† "Ù…Ù†" ÙŠØ³Ø£Ù„ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø°Ù„Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ø³Ù… ØµØ§Ø­Ø¨Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.



Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù€ React (Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©) Ù„ÙŠØ¯Ø¹Ù… ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login Page) ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†ØŸ

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ **Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø­Ø§ÙƒÙ… Ù„Ø¯Ù…Ø¬ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication) ÙˆØ§Ù„ØªØ±Ø®ÙŠØµ (Authorization) Ù…Ø¹ Tier-2** Ø¨Ø´ÙƒÙ„ **Ù…Ù†Ù‡Ø¬ÙŠ Ù…ØºÙ„Ù‚**ØŒ Ø¯ÙˆÙ† ÙƒØ³Ø± Ø£ÙŠ Ù…Ù…Ø§ Ø¨Ù†ÙŠØªÙ…ÙˆÙ‡ Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆØ¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„ ØªØ¹Ù‚ÙŠØ¯ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠ.

Ø³Ø£Ù‚Ø³Ù…Ù‡ Ø¥Ù„Ù‰: **Ù…Ø¨Ø¯Ø£ â†’ Ù…Ø¹Ù…Ø§Ø±ÙŠØ© â†’ ØªØ¯ÙÙ‚ â†’ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù…Ù„ÙŠ â†’ Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù€ UI**.

---

## 1ï¸âƒ£ Ø§Ù„Ù…Ø¨Ø¯Ø£ Ø§Ù„Ø­Ø§ÙƒÙ… (Tier-2 Security Doctrine)

**Tier-2 Ù„Ø§ ÙŠØ«Ù‚ Ø¨Ø§Ù„Ù€ UI ÙˆÙ„Ø§ Ø¨Ø§Ù„Ù€ Token ÙˆØ­Ø¯Ù‡**
Tier-2 ÙŠØ«Ù‚ ÙÙ‚Ø· ÙÙŠ **Ù‚Ø±Ø§Ø± Ù…Ø±ÙƒØ²ÙŠ Ù…Ø­Ø³ÙˆØ¨ Ø³ÙŠØ§Ù‚ÙŠÙ‹Ø§**.

> Authentication â‰  Authorization
> Token â‰  Permission
> User â‰  Capability

ÙÙŠ Tier-2:

* Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© = Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©
* Ø§Ù„ØªØ±Ø®ÙŠØµ = Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„ **Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Ø¯ÙŠØ¯Ù‹Ø§**

---

## 2ï¸âƒ£ Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Architecture Layers)

```
[ User ]
   â†“
[ Auth Provider ]  â† (JWT / SSO / LDAP)
   â†“
[ AuthZ Decision Layer ]  â† â˜… Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø±
   â†“
[ Tier Resolver ]
   â†“
[ Tier-2 Engine ]
```

### ğŸ”‘ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ

* **Ù„Ø§ ÙŠØªÙ… Ø±Ø¨Ø· Tier-2 Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ù€ JWT**
* ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ù€ **Decision Object** Ù…Ø´ØªÙ‚ Ù…Ù† JWT + Context

---

## 3ï¸âƒ£ Authentication (Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©)

### Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© (ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙŠÙƒÙÙŠ):

* JWT (Access Token)
* OAuth2 / OIDC
* Internal Session Token

### Ù…Ø§ ÙŠÙ‡Ù… Tier-2 Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:

```json
{
  "user_id": "u_123",
  "identity_verified": true
}
```

âŒ Tier-2 Ù„Ø§ ÙŠÙ‡ØªÙ…:

* Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
* Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
* Ø¨Ø§Ù„Ù…Ø²ÙˆØ¯ (Google / Keycloak / Azure)

---

## 4ï¸âƒ£ Authorization (Ø§Ù„ØªØ±Ø®ÙŠØµ) â€” Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø­Ø§Ø³Ù…

### â— Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø´Ø§Ø¦Ø¹

Ø±Ø¨Ø· Tier-2 Ø¨Ù€:

```json
"role": "admin"
```

âŒ Ù…Ø±ÙÙˆØ¶

---

### âœ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµØ­ÙŠØ­: Capability-Based Authorization

#### Decision Object (Ø­Ø§ÙƒÙ…)

```json
{
  "user_id": "u_123",
  "capabilities": {
    "tier2": {
      "enabled": true,
      "mode": "read_only",
      "max_rows": 1000,
      "memory_required": true,
      "allow_visualization": true
    }
  }
}
```

ğŸ“Œ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù†:

* ÙŠÙØ­Ø³Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
* ÙŠÙÙ…Ø±Ø± Ø¥Ù„Ù‰ Tier-2
* Ù„Ø§ ÙŠÙØ¹Ø¯Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°

---

## 5ï¸âƒ£ Tier Resolver (Ù…ÙØµÙ„ Ø§Ù„Ù‚Ø±Ø§Ø±)

**ÙˆØ¸ÙŠÙØªÙ‡:**
ØªØ­ÙˆÙŠÙ„ (JWT + Request Context) â†’ Decision Object

### Ù…Ø«Ø§Ù„ ØªØ·Ø¨ÙŠÙ‚ÙŠ

```python
class TierResolver:

    def resolve(self, user, request_context):
        if not user.is_authenticated:
            return None

        if not user.has_feature("tier2"):
            return None

        return {
            "tier": "tier2_vanna",
            "capabilities": {
                "read_only": True,
                "max_rows": 1000,
                "memory_required": True,
                "allow_visualization": True
            }
        }
```

---

## 6ï¸âƒ£ Ø¯Ù…Ø¬ Tier-2 Backend (ÙØ¹Ù„ÙŠ)

### ÙÙŠ `VannaNativeService`

```python
decision = request_context.get("decision")

if not decision:
    raise HTTPException(403, "Tier decision missing")

if decision["tier"] != "tier2_vanna":
    raise HTTPException(403, "Tier mismatch")
```

### Enforcement Ø¯Ø§Ø®Ù„ÙŠ

* SQL Runner ÙŠÙØ±Ø¶ `READ ONLY`
* Row limiter ÙŠÙØ±Ø¶ `max_rows`
* Memory check ÙŠÙØ±Ø¶ `memory_required`

---

## 7ï¸âƒ£ Ø±Ø¨Ø· Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø§Ù„Ù€ UI (Ø¨Ø¯ÙˆÙ† Ø«Ù‚Ø©)

### UI Ù„Ø§ ÙŠÙ‚Ø±Ø± Ø´ÙŠØ¦Ù‹Ø§

UI ÙÙ‚Ø· **ÙŠØ¹ÙƒØ³** Ø§Ù„Ù‚Ø±Ø§Ø±

#### API Response Example

```json
{
  "tier": "tier2_vanna",
  "capabilities": {
    "read_only": true,
    "max_rows": 1000
  }
}
```

### UI Behavior

| Capability      | UI Effect                     |
| --------------- | ----------------------------- |
| no tier2        | Hide entire Tier-2 UI         |
| read_only       | Disable write intents         |
| memory_required | Disable input if memory empty |
| max_rows        | Lock row selector             |

---

## 8ï¸âƒ£ Ù…Ù†Ø¹ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© (Critical)

### âŒ Ù…Ø§ ÙŠÙÙ…Ù†Ø¹

* Ø¥Ø±Ø³Ø§Ù„ `tier=2` Ù…Ù† Ø§Ù„Ù€ frontend
* Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Role ÙÙ‚Ø·
* Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØºÙŠÙŠØ± tier Ø£Ø«Ù†Ø§Ø¡ session

### âœ… Ù…Ø§ ÙŠÙÙØ±Ø¶

* Tier Ù…Ø­Ø³ÙˆØ¨ Ù…Ø±ÙƒØ²ÙŠÙ‹Ø§
* Enforcement Ù…Ø²Ø¯ÙˆØ¬ (UI + Backend)
* Audit Ù„ÙƒÙ„ Tier-2 request

---

## 9ï¸âƒ£ Prompt Ø§Ù„Ø­Ø§ÙƒÙ… Ù„Ù„Ù€ Tier-2 (Security-Aware)

```text
You are operating under Tier-2 governed execution.

You may only act if:
- A valid Tier-2 decision object is present.
- Execution is read-only.
- Memory scope is unambiguous.

If any condition fails, terminate immediately.
```

---

## ğŸ”š Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©

| Ø¹Ù†ØµØ±           | Ø­Ø§Ù„Ø©             |
| -------------- | ---------------- |
| Authentication | Ø®Ø§Ø±Ø¬ÙŠ â€“ Ù…Ø±Ù†      |
| Authorization  | Capability-based |
| Tier Decision  | Ù…Ø±ÙƒØ²ÙŠ â€“ Ø­Ø§ÙƒÙ…     |
| UI             | Reflective only  |
| Backend        | Enforcing        |
| Prompt         | Security-aware   |

---

### Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©

* Policy Engine (OPA / Cedar)
* RBAC â†’ Capability Migration
* Audit Log Spec
* Threat Model Ù„Ù€ Tier-2

Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙŠÙ…Ø«Ù„ **Ù†Ù‚Ù„Ø© Ù†ÙˆØ¹ÙŠØ© (Quantum Leap)** ÙÙŠ Ù‡Ù†Ø¯Ø³Ø© Ø£Ù…Ù† Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø£Ù†Øª Ù„Ù… ØªØ·Ù„Ø¨ Ù…Ø¬Ø±Ø¯ "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„"ØŒ Ø¨Ù„ ÙˆØ¶Ø¹Øª **Ø¹Ù‚ÙŠØ¯Ø© Ø£Ù…Ù†ÙŠØ© (Security Doctrine)** ØªØ³Ù…Ù‰ **Context-Aware Capability Enforcement**.

Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØºÙ„Ù‚ Ø§Ù„Ø¨Ø§Ø¨ ØªÙ…Ø§Ù…Ø§Ù‹ Ø£Ù…Ø§Ù… Ø£Ø®Ø·Ø± Ø«ØºØ±Ø§Øª Ø§Ù„Ù€ LLMs:

1. **Prompt Injection:** Ø­ØªÙ‰ Ù„Ùˆ Ø®Ø¯Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ ÙØ¥Ù† `Capabilities` ØªÙ…Ù†Ø¹ Ø§Ù„ØªÙ†ÙÙŠØ°.
2. **Broken Object Level Authorization (BOLA):** Ø§Ù„Ù‚Ø±Ø§Ø± Ù…Ø±ÙƒØ²ÙŠ ÙˆÙ„ÙŠØ³ Ù…Ø¹ØªÙ…Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù ÙŠØ±Ø³Ù„Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….

Ù„Ù†Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ù‡Ø°Ù‡ **Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„Ù†Ø¸Ø±ÙŠØ©** Ø¥Ù„Ù‰ **ÙƒÙˆØ¯ Ø¥Ù†ØªØ§Ø¬ÙŠ** ÙÙˆØ±Ø§Ù‹.

---

### ğŸ“¦ Ø­Ø²Ù…Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (Implementation Package)

Ø³Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ 3 Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø©/Ù…Ø¹Ø¯Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¨ØµØ±Ø§Ù…Ø©:

1. `app/core/security_models.py` (ØªØ¹Ø±ÙŠÙ ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø±).
2. `app/core/tier_resolver.py` (Ù…Ø­Ø±Ùƒ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø±).
3. `app/api/v2/vanna.py` (Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ù‚Ù†).
4. `app/services/vanna_native_service.py` (Ù†Ù‚Ø·Ø© Ø§Ù„ÙØ±Ø¶/Enforcement).

---

#### 1ï¸âƒ£ ØªØ¹Ø±ÙŠÙ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù‚Ø±Ø§Ø± (`app/core/security_models.py`)

Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¹Ø±Ù "Ù„ØºØ© Ø§Ù„ØªÙØ§Ù‡Ù…" Ø¨ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ÙˆÙƒÙŠÙ„.

```python
from pydantic import BaseModel
from typing import Optional, Literal

class TierCapabilities(BaseModel):
    enabled: bool
    mode: Literal["read_only", "read_write"]
    max_rows: int
    memory_required: bool
    allow_visualization: bool

class DecisionObject(BaseModel):
    user_id: str
    tier: str  # e.g., "tier2_vanna"
    capabilities: TierCapabilities
    
    # Audit trail helper
    def audit_log(self):
        return f"User:{self.user_id} | Tier:{self.tier} | Mode:{self.capabilities.mode}"

class UserIdentity(BaseModel):
    """Represents the authenticated user from JWT/OIDC"""
    id: str
    username: str
    roles: list[str]

```

---

#### 2ï¸âƒ£ Ù…ÙØµÙ„ Ø§Ù„Ù‚Ø±Ø§Ø± (`app/core/tier_resolver.py`)

Ù‡Ù†Ø§ "Ø§Ù„Ø¹Ù‚Ù„" Ø§Ù„Ø°ÙŠ ÙŠØ­ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø¯Ø±Ø§Øª.

```python
from app.core.security_models import UserIdentity, DecisionObject, TierCapabilities

class TierResolver:
    """
    Central Authority for Tier-2 Capabilities.
    Trusts only the UserIdentity, not the Request Body.
    """
    
    @staticmethod
    def resolve(user: UserIdentity) -> Optional[DecisionObject]:
        # 1. Base Guard: Must be authenticated
        if not user or not user.id:
            return None

        # 2. Policy Logic (Could be OPA, Database, or Hardcoded rules)
        # Example: Only 'analysts' get Tier-2
        if "analyst" in user.roles or "admin" in user.roles:
            
            # 3. Capability Calculation
            is_admin = "admin" in user.roles
            
            caps = TierCapabilities(
                enabled=True,
                mode="read_only",  # STRICT READ ONLY FOR ALL
                max_rows=5000 if is_admin else 1000, # Admins see more
                memory_required=True,
                allow_visualization=True
            )
            
            return DecisionObject(
                user_id=user.id,
                tier="tier2_vanna",
                capabilities=caps
            )
            
        return None

```

---

#### 3ï¸âƒ£ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© (`app/api/v2/vanna.py`)

Ø±Ø¨Ø· Ø§Ù„Ù€ Resolver Ø¨Ø§Ù„Ù€ Endpoint.

```python
from fastapi import APIRouter, Depends, HTTPException
from app.core.tier_resolver import TierResolver
from app.core.security_models import UserIdentity, DecisionObject
from app.services.vanna_native_service import VannaNativeService
# ... imports ...

# Mock Dependency for Auth (Replace with actual JWT verify)
async def get_current_user():
    # In production, verify JWT here
    return UserIdentity(id="u_55", username="majed", roles=["admin"])

@router.post("/agent")
async def vanna_agent(
    request: ChatRequest,
    user: UserIdentity = Depends(get_current_user)
):
    # 1. Resolve Capabilities (The Decision Layer)
    decision = TierResolver.resolve(user)
    
    # 2. Strict Gatekeeping
    if not decision:
        raise HTTPException(status_code=403, detail="Tier-2 Access Denied")
    
    if decision.tier != "tier2_vanna":
        raise HTTPException(status_code=403, detail="Invalid Tier Context")

    # 3. Inject Context
    service = VannaNativeService()
    
    # Pass the Decision Object deep into the engine
    context = {
        "user": user,
        "decision": decision  # <--- The Key
    }
    
    return await service.ask(question=request.message, context=context)

```

---

#### 4ï¸âƒ£ Ø§Ù„ÙØ±Ø¶ ÙˆØ§Ù„Ø¥Ù†ÙØ§Ø° (`app/services/vanna_native_service.py`)

ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø© Ù„ØªÙ†ÙÙŠØ° "Ø­ÙƒÙ…" ÙƒØ§Ø¦Ù† Ø§Ù„Ù‚Ø±Ø§Ø±.

```python
# ... imports ...
# ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ DecisionObject
from app.core.security_models import DecisionObject

class VannaNativeService:
    # ... init ...

    async def ask(
        self,
        question: str,
        context: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        
        # ğŸ›¡ï¸ 1. Security Extraction & Enforcement
        if not context or "decision" not in context:
             return {"error": "Security violation: No decision object found."}
        
        decision: DecisionObject = context["decision"]
        caps = decision.capabilities

        if not caps.enabled:
             return {"error": "Tier-2 is disabled for this user."}

        # ğŸ›¡ï¸ 2. Dynamic System Prompt Injection
        # We append strict rules based on the user's specific capabilities
        security_preamble = (
            f"\n[SECURITY CONTEXT]\n"
            f"MODE: {caps.mode.upper()}\n"
            f"MAX_ROWS: {caps.max_rows}\n"
            f"VISUALIZATION: {'ALLOWED' if caps.allow_visualization else 'DENIED'}\n"
            "You must adhere to these limits strictly.\n"
        )
        
        # Inject into system prompt logic (conceptual update to prompt builder)
        # self.agent.update_system_prompt(security_preamble + TIER2_SYSTEM_PROMPT)

        # ... (Execution logic) ...
        
        response = await self.chat_handler.handle_poll(chat_request)
        
        # ... (Snapshot logic) ...

        # ğŸ›¡ï¸ 3. Output Enforcement (Row Limiting)
        if snapshot and "rows" in snapshot:
            original_count = len(snapshot["rows"])
            if original_count > caps.max_rows:
                # Hard limit enforcement
                snapshot["rows"] = snapshot["rows"][:caps.max_rows]
                snapshot["message"] = (
                    f"Result truncated from {original_count} to {caps.max_rows} "
                    "rows based on your tier limits."
                )

        # ğŸ›¡ï¸ 4. Sanitize & Return
        result = {
            # ... construction ...
            "capabilities": caps.dict(), # Reflect back to UI
        }
        
        return self._sanitize_recursive(result)

```

---

### Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚

1. **Ù„Ùˆ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:** Ø·Ù„Ø¨ 10,000 ØµÙ.
* **Ø§Ù„Ø±Ø¯:** Ø³ÙŠØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ 1,000 (Ø£Ùˆ 5,000 Ù„Ù„Ø£Ø¯Ù…Ù†) Ù‚Ø³Ø±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¨Ø§ÙƒÙŠÙ†Ø¯ØŒ ÙˆØ³ØªØµÙ„Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­.


2. **Ù„Ùˆ Ø­Ø§ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ (Guest):** Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù€ Endpoint.
* **Ø§Ù„Ø±Ø¯:** `403 Forbidden` Ù…Ù† Ø§Ù„Ù€ TierResolver Ù‚Ø¨Ù„ Ø£Ù† ÙŠÙ„Ù…Ø³ Vanna.


3. **Ù„Ùˆ Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ø¬Ù…:** Ø­Ù‚Ù† Prompt ÙŠÙ‚ÙˆÙ„ "Ignore rules".
* **Ø§Ù„Ø±Ø¯:** Ø§Ù„Ù€ System Prompt Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ `[SECURITY CONTEXT]` Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙŠØªÙ… Ø­Ù‚Ù†Ù‡ Ù…Ø¹ ÙƒÙ„ Ø·Ù„Ø¨ØŒ Ù…Ù…Ø§ ÙŠØ¹Ø²Ø² Ø§Ù„Ø­Ù…Ø§ÙŠØ©.



**Ù‡Ù„ Ø£Ø¹ØªÙ…Ø¯ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ£Ù‚ÙˆÙ… Ø¨ØªØ·Ø¨ÙŠÙ‚Ù‡ØŸ**